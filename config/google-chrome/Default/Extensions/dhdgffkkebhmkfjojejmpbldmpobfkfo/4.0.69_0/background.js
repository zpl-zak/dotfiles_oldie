'use strict';var trup,init,lfgs,sycl,cfgo,uris,clip,dast,perm,blak,scbr,exts,down;
Registry.require("promise statistics convert xmlhttprequest downloads cache storage uri compat parser layout helper syncinfo notify asker i18n native".split(" "),function(){var p=Registry.log,q=rea.FEATURES,fa=function(){var b=[],n=!0,d=function(b,d,c){var a={title:b.join("\n\n")};d.path=rea.extension.getURL("images/icon"+(d.frag?"_"+d.frag:"")+".png");p.warn(b.join("\n"));rea.browserAction.setIcon({path:d.path});rea.browserAction.setTitle(a);d=function(a,c,d){a={name:"1",sub_menu_item:!0,pos:"left",
items:[]};a.items.push({name:b[0],image:"info"});1<b.length&&a.items.push({name:b[1]});d({items:[a],options:{enabled:!1}})};c||rea.extension.onMessage.addListener(d)};return{run:function(){try{Registry.verify("69").length&&(n=!1,d(["Tampermonkey detected that browser is caching some outdated code parts.","In order to avoid unexpected behavior TM will be kept paused until your browser was restarted."],{frag:"paused"}))}catch(b){n=!1,p.error(b.message)}if("chromeStorage"==q.DB.USE&&!q.DB.NO_WARNING){var f=
function(){if(!t)return window.setTimeout(f,2E3);t.isWorking().fail(function(){confirm("Tampermonkey detected that the extension storage is unreliable!\n\nUnfortunately this means that all your settings and userscripts are inaccessible at the moment.\n\nDo you want to visit the FAQ entry that explains how to recover from that?")&&rea.tabs.create({url:"http://tampermonkey.net/faq#Q206"},function(){});d(["Tampermonkey detected that the extension storage is unreliable!"],{frag:"paused"},!0)})};window.setTimeout(f,
1E3)}return n},pause:d,setWarning:function(d,h,c){b.push({text:d,description:h,url:c})},getWarnings:function(){return b}}}();if(fa.run()){var l=Registry.get("promise"),u=Registry.get("helper"),J=Registry.get("cache"),L=Registry.get("statistics"),t=Registry.get("storage"),P=Registry.get("notify"),ba=Registry.get("asker"),M=Registry.get("native"),Aa=Registry.get("permission"),qa=Registry.get("layout"),A=Registry.get("uri"),e=Registry.get("i18n"),G=Registry.get("downloads");uris=A;down=G;perm=Aa;dast=
t;var ra=u.createUUID(),N={},V={};p.debug("Starting background fred @"+ra);J.create("rundata").setOptions({timeout:180,check_interval:120,retimeout_on_get:!0}).init();J.create("regexp").setOptions({timeout:3600,check_interval:120,retimeout_on_get:!0}).init();var Ca=function(){var b=l(),n,d,f=rea.extension.manifest.version,h=t.getSchemaVersion(),c=h;t.getVersion("0.0.0.0").then(function(a){d=a;n=x.versionCmp(f,d)==x.versionCmp.eNEWER;return t.isWiped()}).then(function(a){!n&&a&&(a=["Tampermonkey detected inconsistencies that indicate that your browser wiped the extension database!",
"You can continue to use Tampermonkey normally, but your settings and scripts might be lost. Click here to get more information.","http://tampermonkey.net/faq.php#Q207"],p.warn(a.join("\n")),fa.setWarning.apply(this,a))}).always(function(){var a=[],m=0,k=function(){if(m<a.length){var d=a[m].schema;a[m].cond(d)?a[m].fn().done(function(){d&&(p.log("Converted database from",c,"to",d),c=d);m++;k()}).fail(function(){b.reject()}):(m++,k())}},e=function(){p.warn("Incognito mode detected. Database conversion can only be done in non-incognito mode! Stopping now...");
fa.pause(["Tampermonkey needs to convert its database but this can't be done in incogonito mode!","Please open a non-incognito mode window and/or restart your browser."],{frag:"paused"})},a=[{cond:function(){return n&&!q.RUNTIME.FIREFOX&&"chromeStorage"==q.DB.USE&&!t.getValue(q.CONSTANTS.STORAGE.LEGACY_VERSION)&&x.versionCmp("3.5.3603",d)==x.versionCmp.eNEWER},fn:function(){var a=l();rea.extension.inIncognitoContext?(e(),a.reject()):(p.log("Update database..."),c="3.5.3603",t.migrate("sql","chromeStorage").done(function(){p.log("Copied config for default usage of chrome storage");
a.resolve()}));return a.promise()}},{cond:function(){return n&&x.versionCmp("3.6.3650",c)==x.versionCmp.eNEWER&&x.versionCmp("3.5.3650",d)==x.versionCmp.eNEWER},fn:function(){var a=l();if(rea.extension.inIncognitoContext)e(),a.reject();else{c="3.6.3650";var b=[];[{o:"TM_config",n:q.CONSTANTS.STORAGE.CONFIG},{o:"TM_update_check",n:q.CONSTANTS.STORAGE.UPDATE},{o:"TM_version"},{o:"TM_unload_ts"}].forEach(function(a){if(a.n){var c=t.getValue(a.o);void 0!==c&&b.push(t.setValue(a.n,c))}b.push(t.deleteValue(a.o))});
var k=/@re$/,m=[];t.listValues().forEach(function(a){-1!=a.search(k)&&(a=a.replace(k,""),m.push(a))});m.forEach(function(a){var c=t.getValue(a+"@st"),d=t.getValue(a),k=t.getValue(a+"@re"),m=t.getValue(a+"@source"),f=y.getUidByName(a)||u.createUUID();b.push(t.deleteValue(a+"@st"));b.push(t.deleteValue(a));b.push(t.deleteValue(a+"@re"));b.push(t.deleteValue(a+"@source"));d&&k&&m?(b.push(t.setValue(q.CONSTANTS.PREFIX.SCRIPT_UID+f,a)),b.push(t.setValue(q.CONSTANTS.PREFIX.COND+f,k)),b.push(t.setValue(q.CONSTANTS.PREFIX.STORE+
f,c)),b.push(t.setValue(q.CONSTANTS.PREFIX.SCRIPT+f,m)),b.push(t.setValue(q.CONSTANTS.PREFIX.META+f,d))):p.warn("invalid script entry",{source:m,meta:d,cond:k})});k=/@st$/;t.listValues().forEach(function(a){-1!=a.search(k)&&b.push(t.deleteValue(a))});l.when(b).done(function(){p.log("Converted database from",d,"to",c);a.resolve()})}return a.promise()}},{schema:"3.7.0",cond:function(a){return x.versionCmp(a,c)==x.versionCmp.eNEWER},fn:function(){var a=l();if(rea.extension.inIncognitoContext)e(),a.reject();
else{var b=[],c=new RegExp("^"+q.CONSTANTS.PREFIX.META);t.listValues().forEach(function(a){if(-1!=a.search(c)){var d=t.getValue(a);d.options&&d.options.override&&!d.options.override.orig_run_at&&(d.options.override.orig_run_at=d.options.run_at||"document-idle",d.options.run_at=null,b.push(t.setValue(a,d)))}});l.when(b).done(function(){a.resolve()})}return a.promise()}},{schema:"4258",cond:function(a){return x.versionCmp(a,c)==x.versionCmp.eNEWER},fn:function(){var a=l();if(rea.extension.inIncognitoContext)e(),
a.reject();else{var b=t.getValue(q.CONSTANTS.STORAGE.CONFIG);b&&b.sync_enabled&&2==b.sync_type&&(b.sync_version=1,t.setValue(q.CONSTANTS.STORAGE.CONFIG,b));a.resolve()}return a.promise()}},{schema:"4526",cond:function(a){return n&&q.RUNTIME.SAFARI&&"chromeStorage"==q.DB.USE&&x.versionCmp(a,c)==x.versionCmp.eNEWER},fn:function(){var a=l();if(rea.extension.inIncognitoContext)e(),a.reject();else{p.log("Update database...");var b=t.migrate("localStorage","chromeStorage").done(function(){p.log("Copied config for default usage of setting storage")});
a.consume(b)}return a.promise()}},{schema:"4871",cond:function(a){return n&&x.versionCmp(a,c)==x.versionCmp.eNEWER},fn:function(){var a=l(),b,c,d=t.getValue(q.CONSTANTS.STORAGE.CONFIG);d&&d.scriptTemplate&&(c=g.getDefaults())&&(b=c.script_templates)&&b[0]&&b[0].value&&(b[0].value=d.scriptTemplate,delete d.scriptTemplate,t.setValue(q.CONSTANTS.STORAGE.CONFIG,d));a.resolve();return a.promise()}},{cond:function(){return n||x.versionCmp(c,h)==x.versionCmp.eNEWER},fn:function(){var a=l();t.setVersion(f,
c).done(function(){a.resolve()});return a.promise()}},{cond:function(){return n},fn:function(){p.log("First run of version "+f+"!");Ba.scheduleNotification(d,"0.0.0.0"==d);return l.Pledge()}},{cond:function(){return!0},fn:function(){var a=l();b.resolve();window.setTimeout(a.resolve,q.MISC.TIMEOUT);return a.promise()}}];k()});return b.promise()},ja=function(){return{get:function(b,n){var d=(0==b)+"#"+n,f=J.items.rundata.getj(d);if(f)f=f.oldret;else{var f=[],h=0,c={};if(n)for(var a=w.determineScriptsToRun(n),
m=0;m<a.length;m++){var k=a[m];k.enabled?k.evilness&&k.evilness>=g.values.script_blacklist_severity||0!=b&&(!0===k.options.noframes||null===k.options.noframes&&!0===k.options.override.orig_noframes)||w.isContexter(k)||(c[k.name]=!0,f.push(k)):h++}f={runners:f,disabled:h,script_map:c};n&&J.items.rundata.setj(d,{frameId:b,oldret:f})}return f},getContexters:function(b,n){for(var d=[],f=w.determineScriptsToRun(n),h=0;h<f.length;h++){var c=f[h];c.enabled&&(0==b||!0!==c.options.noframes&&(null!==c.options.noframes||
!0!==c.options.override.orig_noframes))&&w.isContexter(c)&&d.push(c)}return d}}}(),B=function(){var b={},n=1,d=n++,f=n++,h=n++,c=n++,a=n++,m=n++,k=n++,e=function(){var a={frames:{0:{state:d}},tabs:{reset_ts:Date.now()},scripts:{},urls:{},maps:{},contexts:{onUnload:{}},stats:{running:0,disabled:0},extra:{}};Object.defineProperties(a.urls,{length:{value:0,enumerable:!1,writable:!0,configurable:!0}});return a},C={},r={},v={},F={},z={listeners:{once:{whenReady:function(a,c){if(!b[a]||b[a].frames[0].state<
h)z.listeners.once.onReady(a,c);else c()},onReady:function(a,b){var c=function(a){z.listeners.remove.onCommited(d);z.listeners.remove.onCompleted(k);a&&b()},d=z.listeners.add.onCommited(function(b){b===a&&c(!0)}),k=z.listeners.add.onCompleted(function(b){b===a&&c(!0)})}},add:{onReset:function(a){var b=u.createUUID();C[b]=a;return b},onCommited:function(a){var b=u.createUUID();r[b]=a;return b},onCompleted:function(a){var b=u.createUUID();v[b]=a;return b},onRemoved:function(a){var b=u.createUUID();
F[b]=a;return b}},remove:function(){return{onReset:function(a){delete C[a]},onCommited:function(a){delete r[a]},onCompleted:function(a){delete v[a]},onRemoved:function(a){delete F[a]}}}()},events:{reset:function(a,c){b[a]=e();b[a].frames[0].state=d;u.each(C,function(b){b&&b(a,c)})},response:function(a,c,k){if(g.values.enabled){b[a]=b[a]||e();b[a].frames[c]=b[a].frames[c]||{};var m=b[a].frames[c].state||d;b[a].frames[c].state=f;0===c&&(b[a].tabs.response_ts=Date.now());k=A.woHash(k);m<f&&z.scripts.determine(a,
c,k);return(a=b[a].scripts[k])?a.runners.length:0}},commited:function(a,c,k){if(g.values.enabled){var m=A.parse(k);if("http:"===m.protocol||"https:"===m.protocol||"file:"===m.protocol)b[a]=b[a]||e(),b[a].frames[c]=b[a].frames[c]||{},m=b[a].frames[c].state||d,b[a].frames[c].state=h,m<f&&(k=A.woHash(k),z.scripts.determine(a,c,k)),u.each(r,function(b){b&&b(a)})}},loading:function(a,k,m){if(g.values.enabled){var h=A.parse(m);"http:"!==h.protocol&&"https:"!==h.protocol&&"file:"!==h.protocol||0!==k||"file:"!==
h.protocol||(b[a]=b[a]||e(),b[a].frames[k]=b[a].frames[k]||{},h=b[a].frames[k].state||d,b[a].frames[k].state=c,h<f&&(m=A.woHash(m),z.scripts.determine(a,k,m)))}},run:function(c,d,k,m,f){if(g.values.enabled){var h=0===d?d:k;b[c]=b[c]||e();b[c].frames[h]=b[c].frames[h]||{};b[c].frames[h].state=a;var n=A.woHash(m);m=b[c].scripts[n];if(!m&&(z.scripts.determine(c,d,n),m=b[c].scripts[n],!m)){p.warn("tv: no script run info for tab "+c+" @ "+n,p.D?b[c].scripts:"");return}z.scripts.updateMaps(c,k,m.script_map);
z.scripts.updateUrls(c,d,k,n);z.scripts.updateStats(c,k,m.runners.length,m.disabled);z.scripts.run(c,d,k,n,m.runners,function(a){b[c]&&delete b[c].scripts[n];f(a)})}},complete:function(c,k,f){f=A.parse(f);if(g.values.enabled&&("http:"===f.protocol||"https:"===f.protocol||"file:"===f.protocol)){if(0===k){b[c]=b[c]||e();b[c].frames[k]=b[c].frames[k]||{};var h=b[c].frames[k].state||d;b[c].frames[k].state=m;if(!B.get.empty(c)&&B.get.stats(c).running){if(h<a){p.warn("tv: no script run info!");return}"file:"===
f.protocol?window.setTimeout(function(){rea.tabs.sendMessage(c,{method:"onLoad",frameId:k},function(){})},500):rea.tabs.sendMessage(c,{method:"onLoad",frameId:k},function(){})}}u.each(v,function(a){a&&a(c)})}},unload:function(a,c,d){c=0===c?c:d;b[a]=b[a]||e();b[a].frames[c]=b[a].frames[c]||{};b[a].frames[c].state=k;if(b[a]&&b[a].contexts.onUnload[d]){for(c=0;c<b[a].contexts.onUnload[d].length;c++)b[a].contexts.onUnload[d][c]();b[a].contexts.onUnload[d]=[]}},remove:function(a){delete b[a];u.each(F,
function(c){c&&c(a)})}},scripts:{updateStats:function(a,c,d,k){b[a].stats.running+=d;b[a].stats.disabled+=k;b[a].contexts.onUnload[c]=b[a].contexts.onUnload[c]||[];b[a].contexts.onUnload[c].push(function(){b[a].stats.running-=d;b[a].stats.disabled-=k});b[a].tabs.ts=Date.now()},updateMaps:function(a,c,d){var k=1,m=function(c,d){void 0===b[a].maps[d]&&1===k&&(b[a].maps[d]=0);b[a].maps[d]+=k};u.each(d,m);b[a].contexts.onUnload[c]=b[a].contexts.onUnload[c]||[];b[a].contexts.onUnload[c].push(function(){b[a]&&
(k=-1,u.each(d,m))})},updateUrls:function(a,c,d,k){var m=function(d){1===d&&(void 0===b[a].urls[k]?b[a].urls[k]={frameId:c,count:0}:0===c&&(b[a].urls[k].frameId=c));b[a].urls[k].count+=d;b[a].urls.length=-1};m(1);b[a].contexts.onUnload[d]=b[a].contexts.onUnload[d]||[];b[a].contexts.onUnload[d].push(function(){b[a]&&m(-1)})},determine:function(a,c,d){var k=null;ca.isAllowed(d)?k=d:(p.debug("This URL is filtered by the security settings:",d,"-> Do nothing!"),B.set.forbidden(a,c));c=ja.get(c,k);b[a].scripts[d]=
c;return c.runners.length},run:function(a,c,b,d,k,m){a=[];c=q.RUNTIME.ALLOWS_FAST_DOCUMENT_START&&g.values.runtime_fastDocumentStart;for(b=0;b<k.length;b++){var f=k[b];a.push(sa.bundle({url:d},f,c&&("document-start"===f.options.run_at||!f.options.run_at&&"document-start"===f.options.override.orig_run_at)))}l.when(a).always(m)}},set:{extra:function(a,c,d,k){b[a]=b[a]||e();null===c?b[a].extra[d]=k:(b[a].extra[d]=b[a].extra[d]||{},b[a].extra[d][c]=k)},blocker:function(a){z.set.extra(a,null,"blocker",
!0)},forbidden:function(a,c){0===c&&z.set.extra(a,null,"forbidden",!0)}},get:{extra:function(a,c,d,k){void 0===k&&(k=null);var m=null,m=(b[a]?b[a].extra:{})[d];null!==c&&m&&(m=m[c]);return m||k},empty:function(a){var c=!0;if(b[a]&&0!=b[a].urls.length){if(-1==b[a].urls.length)return b[a].urls.length=0,u.each(b[a].urls,function(c,d){"length"!==d&&0<c.count&&b[a].urls.length++}),z.get.empty(a);c=!1}return c},urls:function(a){return b[a]?b[a].urls:{}},stats:function(a,c){var d={};if(b[a]&&(d.running=
b[a].stats.running,d.disabled=b[a].stats.disabled,c)){d.unique=0;for(var k in b[a].maps)b[a].maps.hasOwnProperty(k)&&0<b[a].maps[k]&&d.unique++}return d},tabs:function(){var a={};u.each(b,function(c,b){a[b]={ts:c.response_ts}});return a},blocker:function(a){return z.get.extra(a,null,"blocker")},forbidden:function(a){return z.get.extra(a,null,"forbidden")}}};return z}(),ka=function(){return{isScriptUrl:function(b){if(!b||-1!=b.search(/\#bypass=true/)||-1!=b.search(q.REQUESTS.GET_INTERNAL_PAGE_REGEXP())||
"data:"===b.substr(0,5))return!1;b=b.split(/[\?#$]/)[0];var n=-1!=b.search(/.+\.user\.(js\#|js\?|js$)/)||-1!=b.search(/.+\.tamper\.(js\#|js\?|js$)/);return n?!(-1!=b.search(/^htt[ps]{1,2}:\/\/code\.google\.com/)||-1!=b.search(/^htt[ps]{1,2}:\/\/github\.com/)&&!w.determineOriginOfUrl(b)):n}}}(),ta=function(){var b=function(b){var d=l(),f=Date.now();b.url+=-1!=b.url.search("\\?")?"&":"?";b.url+="ts="+f;var f=function(a){if(4==a.readyState&&(200==a.status||0==a.status))if("arraybuffer"==h.responseType){if(a.response){d.resolve({decoded:!0,
encoding:b.encoding,content:K.arrbuf2str(a.response,b.encoding)});return}}else if(null!==a.response&&void 0!==a.response){d.resolve({decoded:!0,encoding:b.encoding,content:a.response});return}d.reject({content:""})},h={method:"GET",retries:0,responseType:"arraybuffer",url:b.url};if(b.sync){var c=S(h,{});4==c.readyState&&0==c.status&&c.error&&(delete h.responseType,c=S(h,{}));f(c)}else S(h,{ondone:f});return d.promise()};return{getSource:function(e){"string"===typeof e&&(e={url:e});return b(e)}}}();
lfgs=ta;var ca=function(){return{init:function(){var b=function(){J.items.regexp.remove("PageFilter")};g.addChangeListener("forbiddenPages",b);g.addChangeListener("page_whitelist",b);g.addChangeListener("page_filter_mode",b)},isAllowed:function(b){var e=!1,d=!1,f=0!=g.values.forbiddenPages.length,h=0!=g.values.page_whitelist.length;switch(g.values.page_filter_mode){case "black":d=f;break;case "off":break;case "white":e=h;break;default:e=h,d=f}(f=J.items.regexp.get("PageFilter"))||(f=w.regexify({inc:e?
g.values.page_whitelist:void 0,exc:d?g.values.forbiddenPages:void 0}),J.items.regexp.set("PageFilter",f));return!d&&!e||w.validUrl(b,f)}}}(),Q=function(){var b=function(b,f){var h=!1;if(f.length)return(h="/"==f.substr(0,1)?w.matchUrl(b,w.convertToRegExp(f)):-1!=b.search(f))&&p.debug('black: entry "'+f+'" matched'),h},n={init:function(){var b=l(),f=function(){"server"===g.values.script_blacklist_type&&window.setTimeout(n.checkUpdate,2E4)};f();g.addChangeListener("script_blacklist_type",f);b.resolve();
return b.promise()},getWarningsFor:function(d){var f=[];d&&u.each(g.values.script_blacklist_server,function(h){if(h){var c=e.getUiLocale(),a;u.each(h.rules,function(c){a|=b(d,c);return 1!=a});a&&(h.reasons?f.push(h.reasons[c]||h.reasons.en):h.reason&&f.push(h.reason))}});return f},getEvilnessOf:function(d){if("off"===g.values.script_blacklist_type)return!1;if(!d)return 0;var f=!1,h=0;u.each(g.values.require_blacklist,function(c){f|=b(d,c);return 1!=f});f?h=11:"server"===g.values.script_blacklist_type&&
u.each(g.values.script_blacklist_server,function(c){if(c&&(u.each(c.rules,function(a){f|=b(d,a);return 1!=f}),f))return h=c.severity,!1});return Number(h)},checkUpdate:function(b){var f=l(),h=W.getConfig(),c;if(b||6048E5<Date.now()-h.black.last){var a=function(a,c){var b=l();S({method:"GET",url:a,nocache:c,retries:q.XMLHTTPREQUEST.RETRIES,overrideMimeType:"text/plain; charset=x-user-defined"},{ondone:function(a){b.resolve(a)}});return b.promise()};a("https://blacklist.tampermonkey.net/get.php?version=get").then(function(m){if(4==
m.readyState&&200==m.status){try{c=JSON.parse(m.responseText).version}catch(k){p.warn("black: unable to parse version response! "+m.responseText)}p.info("black: local version: "+h.black.version+" remote: "+c);if(c>h.black.version||b)return a("https://blacklist.tampermonkey.net/get.php",!0)}}).then(function(a){if(a&&4==a.readyState&&200==a.status)try{var c=JSON.parse(a.responseText);c&&c.blacklist&&1==c.version&&(g.values.script_blacklist_server=c.blacklist);p.info("black: updated blacklist to ",c)}catch(b){p.warn("black: blacklist update failed! ",
a.responseText)}}).always(function(){h=W.getConfig();h.black.last=Date.now();h.black.version=c||h.black.version;W.setConfig(h);f.resolve()})}else f.resolve();return f.promise()}};return n}();blak=Q;var Da=function(){for(var b=[],e=[],d=0;d<b.length;d++){var f=Registry.getRaw("system/"+b[d]+".tamper.js");f&&e.push(f)}return e},H=function(){var b=0,n=[],d={to:null,force:null,t:0},f={},h=function(a){p.debug("sync: import",a.uuid,a.name,a.url);var c={imported:g.values.sync_type},b={},d;for(d in r.SYNCED)!0===
r.SYNCED[d]&&(b[d]=a.options[d]);return w.installFromUrl(a.url,{uuid:a.uuid,ask:!1,internal:!0,sync:c,force_options:b},{silent_fail:!0})},c=function(a){p.debug("sync: export",a.name,a.url);return I.add(a)},a=function(a){var c=a.downloadURL?a.downloadURL.split("#")[0]:null,b=a.fileURL?a.fileURL.split("#")[0]:null,d=u.select([b,c],function(a){if(!a||"file:"!==A.parse(a).protocol)return a})[0],c={uuid:a.uuid,name:a.name,options:{},durl:c,furl:b,url:d},k;for(k in r.SYNCED)!0===r.SYNCED[k]&&null!==a.options[k]&&
(c.options[k]=a.options[k]);return c},m=function(){var c=[];y.getUidList().forEach(function(b){b=y.getByUid(b);b.script&&b.cond&&c.push(a(b.script))});return c},k=function(a){if(r.enabled)if(0<b)a&&r.addSyncDoneCallback(function(c){c&&r.sync(50,a)});else{b++;var d=null,k=null,D=!0,C={},q=function(a){if(a){(a=a.split("#")[0])&&(a=a.toLowerCase());for(var c=0;c<d.length;c++){var b=d[c].furl?d[c].furl.toLowerCase():null,k=d[c].durl?d[c].durl.toLowerCase():null;if(b==a||k==a)return d[c]}}return null},
t=function(a){if(a)for(var c=0;c<k.length;c++)if(k[c].uuid==a)return k[c];return null},u=function(a){if(a){a=a.split("#")[0];for(var c=0;c<k.length;c++)if(k[c].url==a)return k[c]}return null},x=function(a){if(!a)return null;for(var c=0;c<d.length;c++)if(d[c].uuid==a)return d[c]};(function(){d=m();return I.list().done(function(a){k=a}).fail(function(){p.warn("sync: unable to get remotelist!")})})().then(function(){for(var a=l(),c=[],b=0;b<k.length;b++)c.push(function(){var a,c=k[b],d=!1,m=!1,n=2==
g.values.sync_version?x(c.uuid):q(c.url);if(n)if(d=!0,C[c.url]=!0,c.uuid&&(C[c.uuid]=!0),c.content&&K.MD5(c.content)!=K.MD5(n.textContent))m=!0;else for(a in r.SYNCED)if(!0===r.SYNCED[a]&&n.options[a]!=c.options[a]){m=!0;break}if(d)if(c.options.removed)p.debug("sync: remove local script",c.uuid,c.name,c.url),w.doRemove(n.uuid,!1);else if(m)if(p.debug("sync: update local script",c.uuid,c.name,c.url),m=y.getByUid(n.uuid),m.script&&m.cond){for(a in r.SYNCED)!0===r.SYNCED[a]&&(m.script.options[a]=c.options[a]);
c.content&&(m.script.textContent=c.content);w.doModify(m.script.uuid,m.script,!1)}else p.warn(e.getMessage("fatal_error")+"("+n.name+")!!!");if(!d&&!c.options.removed)if(a=l(),f[c.url]||c.uuid&&f[c.uuid])p.warn("sync: skip previously failed import",c);else return h(c).done(function(a){a||(p.warn("sync: unable to import",c),f[c.url]=!0,c.uuid&&(f[c.uuid]=!0))}).fail(function(){p.warn("sync: unable to load",c);f[c.url]=!0;c.uuid&&(f[c.uuid]=!0)}).always(a.resolve),a.promise();return l.Pledge()}());
l.when(c).done(function(){a.resolve()});return a.promise()}).then(function(){d=m();return l.Pledge()}).then(function(){if(!I.isWritable())return l.Pledge();for(var a=l(),b=[],k=0;k<d.length;k++)b.push(function(){var a=d[k],b=!1;if(!a.url||C[a.url]||C[a.uuid])return l.Pledge();if(2==g.values.sync_version?t(a.uuid):u(a.url))b=!0;return b?l.Pledge():c(a).done(function(a){})}());l.when(b).done(function(){a.resolve()});return a.promise()}).fail(function(){D=!1}).done(function(){D=!0}).always(function(){p.debug("sync: finished");
if(0==--b)for(var a=D;n.length;)n.shift()(a)})}},D=function(){r.enabled&&r.sync(500,!0)},C=null,r={enabled:!1,SYNCED:{comment:!0},createTeslaData:function(){for(var a=l(),c=[],b=m(),d=0;d<b.length;d++)if(b[d].url){var k=JSON.stringify(b[d].options),k=b[d].name.replace(/\|/g,"!")+"|"+k+"|"+b[d].url.replace(/\|/g,"%7C");c.push(k)}a.resolve(c);return a.promise()},configChangeListener:function(){C||(C=window.setTimeout(function(){C=null;r.init().done(function(){r.enabled&&r.sync(3E3)})},3E3))},init:function(){var a=
l();r.enabled=!1;(function(){return g.values.sync_enabled&&g.values.sync_type?I.init(g.values.sync_type,g.values.sync_version,g.values.sync_id).done(function(a){r.enabled=a;r.enabled?I.addChangeListener(D):p.warn("sync: init failed!")}):l.Pledge()})().always(function(){a.resolve(r.enabled)});return a.promise()},finalize:function(){},reset:function(){return I.reset()},addSyncDoneCallback:function(a){n.push(a)},sync:function(a,c){var b=Date.now();a=a||500;c=d.force||c;d.to?(window.clearTimeout(d.to),
d.ts<b+a&&(a=d.ts-b,1>a&&(a=1))):p.debug("sync: schedule sync for run in "+a+" ms");d.force=c;d.ts=b+a;d.to=window.setTimeout(function(){k(d.force);d.to=null;d.force=null},a)},scriptAddedCb:function(b,d){if(r.enabled&&I.isWritable()){var k=a(d);k.url&&A.parse(k.url).protocol.match(/https?:/)&&c(k)}},scriptChangedCb:function(b,d,k){if(r.enabled&&I.isWritable()&&(b=a(d),b.url))for(var m in r.SYNCED)if(!0===r.SYNCED[m]&&d.options[m]!=k.options[m]){c(b);break}},scriptRemovedCb:function(c,b){if(r.enabled&&
I.isWritable()){var d=a(b);d.url&&(p.debug("sync: remove",d.name,d.url),I.remove(d))}}};return r}();sycl=H;var Ea=function(){g.addChangeListener("sync_enabled",H.configChangeListener);g.addChangeListener("sync_type",H.configChangeListener);g.addChangeListener("sync_id",H.configChangeListener);g.addChangeListener("sync_version",H.configChangeListener);g.addChangeListener("logLevel",function(){p.set(g.values.logLevel)});g.addChangeListener("i18n",function(){e.setLocale(g.values.i18n)});g.addChangeListener("native_import_path",
function(){M.setPath(g.values.native_import_path)});g.addChangeListener("incognito_mode",function(){ua()});g.addChangeListener("statistics_enabled",function(){L.setEnabled(g.values.statistics_enabled)});g.addChangeListener("require_blacklist",w.blackCheckAll);g.addChangeListener("script_blacklist_server",w.blackCheckAll);g.addChangeListener("script_blacklist_type",w.blackCheckAll);g.addChangeListener("downloads_extension_whitelist",G.config_changed_listener);g.addChangeListener("downloads_mode",G.config_changed_listener);
g.addChangeListener("webrequest_modHeaders",function(b,e,d,f){f.done(window.setTimeout(T.reset,1))})},g=function(){var b={},e={enabled:!0,configMode:0,debug:!1,logLevel:0,showFixedSrc:!1,webrequest_modHeaders:"yes",webrequest_fixCSP:"yes",notification_showUpdate:"changelog",notification_silentScriptUpdate:!0,script_templates:[{name:"ECMAScript 5",value:"// ==UserScript==\n// @name         New Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  try to take over the world!\n// @author       You\n// @match        <$URL$>\n// @grant        none\n// ==/UserScript==\n\n(function() {\n    'use strict';\n\n    // Your code here...\n})();"},
{name:"ECMAScript 6",value:"// ==UserScript==\n// @name         New ES6-Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  shows how to use babel compiler\n// @author       You\n// @require      https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser-polyfill.min.js\n// @require      https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser.min.js\n// @match        <$URL$>\n// ==/UserScript==\n\n/* jshint ignore:start */\nvar inline_src = (<><![CDATA[\n/* jshint ignore:end */\n/* jshint esnext: true */\n\n// Your code here...\n\n/* jshint ignore:start */\n]]\x3e</>).toString();\nvar c = babel.transform(inline_src);\neval(c.code);\n/* jshint ignore:end */"},
{name:"CoffeeScript",value:"// ==UserScript==\n// @name         New Coffee-Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  shows how to use coffeescript compiler\n// @author       You\n// @require      http://coffeescript.org/extras/coffee-script.js\n// @match        <$URL$>\n// ==/UserScript==\n/* jshint ignore:start */\nvar inline_src = (<><![CDATA[\n\n// Your code here\n\n]]\x3e</>).toString();\nvar compiled = this.CoffeeScript.compile(inline_src);\neval(compiled);\n/* jshint ignore:end */"}],
scriptUpdateCheckPeriod:864E5,scriptUpdateHideNotificationAfter:15E3,scriptUpdateCheckDisabled:!1,scriptUrlDetection:"auto",runtime_fastDocumentStart:!0,runtime_strict_mode:"byscript",runtime_strong_mode:"default",autoReload:!1,appearance_badges:"running",appearance_badge_color:"gcal"===rea.runtime.short_id?"#444":"#ee3131",editor_enabled:!0,editor_fontSize:100,editor_theme:"default",editor_keyMap:"windows",editor_indentUnit:4,editor_indentWithTabs:!1,editor_tabMode:"indent",editor_electricChars:!0,
editor_autoSave:!1,editor_easySave:!0,editor_autoLint:!0,editor_autoLintMaxLen:5E4,editor_highlightTrailingWhitespace:!0,native_import:!0,native_import_path:null,native_import_post_action:"disable",i18n:null,action_menu_columns:2<=q.ACTIONMENU.COLUMNS?2:1,action_menu_scripts_hide_disabled:!1,action_menu_scripts_sort:"position",incognito_mode:"temporary",layout:"default",sync_enabled:!1,sync_type:2,sync_version:2,sync_id:"",statistics_enabled:!0,downloads_mode:"default",downloads_extension_whitelist:"/^[^\\.]*$/ /\\.mp[34]$/ .wav /\\.(avi|mkv|flv|divx|mpe?g|webm)$/ /\\.(ico|gif|png|jpe?g)/ /\\.(srt|sub|idx)$/ .txt .iso .zip /\\.r(ar|[0-9]{2,2})$/".split(" "),
external_update_interval:6048E5,require_timeout:2E4,require_blacklist:["/^https?:\\/\\/example.com(:[0-9]{1,5})?\\/.*/"],require_sri_mode:"supported",script_blacklist_server:[],script_blacklist_type:"server",script_blacklist_severity:4,connect_mode:"ask",page_filter_mode:"black",page_whitelist:["/https?:\\/\\/greasyfork\\.org\\/.*/","http://xkcd.com/970/"],forbiddenPages:"*example.org/* *paypal.tld/* *stripe.com/* https://*deutsche-bank-24.tld/* https://*bankofamerica.tld/* /^.*:\\/\\/apis\\.google\\.com\\/((?!render)([^\\/]+)\\/)+([^\\/]+)?$/ *://www.facebook.com/plugins/* *://platform.twitter.com/widgets/*".split(" ")},
d=function(d,c){var a=t.getValue(q.CONSTANTS.STORAGE.CONFIG,{}),m=void 0===a[d]?e[d]:a[d];a[d]=c;var k=t.setValue(q.CONSTANTS.STORAGE.CONFIG,a);b[d]&&JSON.stringify(m)!=JSON.stringify(c)&&b[d].forEach(function(a){try{a(d,m,c,k)}catch(b){p.warn("config: changeListener error",b)}})},f={init:function(){var b=l();f.values={};f.__defineGetter__("snapshot",function(){return u.assign({},f.values)});for(var c in e)e.hasOwnProperty(c)&&function(){var a=c;f.values.__defineGetter__(a,function(){var c=t.getValue(q.CONSTANTS.STORAGE.CONFIG,
{});return void 0===c[a]?e[a]:c[a]});f.values.__defineSetter__(a,function(c){d(a,c)})}();f.initialized=!0;var a=Da();Object.keys(a).forEach(function(c){var b=a[c];window.setTimeout(function(){w.doSave({url:null,src:b,ask:!1,replace:!0,internal:!0})},1)});b.resolve();return b.promise()},getDefaults:function(){return e},addChangeListener:function(d,c){b[d]||(b[d]=[]);b[d].push(c)}};return f}(),S=function(b,e){return ga(b,e,{internal:!0})},da=function(){var b={},e=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,
d=new RegExp("("+A.staticVars.url2LevelTlds.replace(/\./g,"\\.")+")$"),f=function(a){var c=a.split(".");if(3>c.length||a.match(e))return a;a=c.slice(-2).join(".").match(d)?-3:-2;return c.slice(a).join(".")},h=function(a){return a&&-1!=a.indexOf("*")},c=function(){var a=l();rea.tabs.getSelected(null,function(c){a.resolve(c)});return a.promise()},a=function(a){var c=l();ca.isAllowed(a)?c.resolve({allowed:!0}):c.resolve({allowed:!1});return c.promise()},m=function(a,c){var b=function(a){return a?a.map(function(a){if(a.match(/^'?self'?$/))a=
A.parse(c.url).hostname||null;else if("'none'"==a)a="none";else if(-1===["none","localhost","*"].indexOf(a)&&(1>a.indexOf(".")||1===(a.match(/\./g)||[]).length&&a.match(d)))return null;return a}):[]};return{connects:a.options.override.merge_connects&&"paranoid"!=g.values.connect_mode?b(a.connects):[],userconnects:b(a.options.override.use_connects),blockers:b(a.options.override.use_blockers)}},k=function(a,c,d){var k=l(),m=function(){k.resolve({permitted:!0})},f=function(a){k.resolve({permitted:!1,
reason:a})},D=function(){k.resolve({unknown:!0})},r,C=function(a,c){var b=null,d=a.match(e);c.every(function(c){if(c.a)for(var k=0;k<c.a.length;k++)if(c.a[k]&&(d?c.a[k]===a:-1!=a.search(new RegExp("(^|.+\\.)"+u.escapeForRegExp(c.a[k])+"$"))))return b=c.blocker?f:m,!1;return!0});return b};if("off"==g.values.connect_mode)m();else if((r=A.parse(d))&&r.hostname)if((d=C(r.hostname,[{a:b[a.uuid]}]))||(d=h(b[a.uuid])?m:null))d();else if(0===c.connects.length&&0===c.userconnects.length&&0===c.blockers.length)"casual"==
g.values.connect_mode?m():"strict"==g.values.connect_mode?f("No @connects given, but strict mode enabled"):D();else if(-1!=c.connects.indexOf("none"))f("None value found");else{if("casual"!=g.values.connect_mode||h(c.blockers)||!(d=h(c.connects)?m:null))(d=h(c.userconnects)?m:null)||(d=C(r.hostname,[{a:c.blockers,blocker:!0},{a:c.connects},{a:c.userconnects}])||D);d()}else f("URL can not be parsed");return k.promise()},D=function(){var a=function(a){for(var c=0;c<r.length;c++)if(r[c].tabId===a)return r.splice(c,
1)[0];return r.pop()},b;c().then(function(c){for(;!C&&(b=a(c.id));)b.fn()})},C,r=[],v=function(a,d,k,m,e){var n,g=l(),v=function(){g.resolve({approved:!0})},F=function(){g.resolve({forbidden:!0})};p.debug('cor: "'+a.name+'" is asking for permission to access',m,d);if((n=A.parse(m))&&n.hostname){var q=f(n.hostname),t=d.tab?d.tab.id:null;C=!0;c().then(function(c){return ba.askForConnect({src_url:d.url,hostname:n.hostname,domain:q,all_domains:h(k.connects),tabid:t,active:t===c.id,timeout:e,url:m,settings_url:rea.extension.getURL("options.html")+
"#nav="+a.uuid+"+settings",connect_url:"http://tampermonkey.net/documentation.php#_connect",script:{name:a.name,uuid:a.uuid,icon:a.icon64||a.icon||rea.extension.getURL("images/txt.png")}})}).done(function(c){var d,k=c.whole_domain?q:n.hostname;c.allow?c.once?(p.debug('cor: allowing "'+a.name+'" to access',k,"once"),v()):c.temporary?(p.debug('cor: allowing "'+a.name+'" to access',k,"temporarily"),void 0===b[a.uuid]&&(b[a.uuid]=[]),-1==b[a.uuid].indexOf(k)&&b[a.uuid].push(k),v()):(d=v,c.all_domains?
(p.debug('cor: allowing "'+a.name+'" to access all domains always'),a.options.override.use_connects.push("*")):(p.debug('cor: allowing "'+a.name+'" to access',k,"always"),a.options.override.use_connects.push(k),d=v)):c.once||c.aborted?(p.debug('cor: denying "'+a.name+'" to access',k,"once"),F()):(a.options.override.use_blockers||(a.options.override.use_blockers=[]),d=F,c.all_domains?(p.debug('cor: denying "'+a.name+'" to access any domains (additional) domain'),a.options.override.use_blockers.push("*")):
(p.debug('cor: denying "'+a.name+'" to access',k,"always"),a.options.override.use_blockers.push(k)));d&&w.doModify(a.uuid,a,!1).always(d)}).fail(F).always(function(){C=!1;r.length&&window.setTimeout(D,1)})}else F();return g.promise()},F=function(c,b,d,f){var e=m(c,b),n=arguments;return a(d).then(function(a){if(!0!==a.allowed)return l.Breach("URL is blacklisted");var m,f;return(m=A.parse(d))&&m.origin&&(f=A.parse(b.url))&&f.origin&&m.origin===f.origin?l.Pledge({permitted:!0}):k(c,e,d)}).then(function(a){if(!1===
a.permitted)return l.Breach("URL is not permitted"+(a.reason?": "+a.reason:""));if(!0===a.permitted)return l.Pledge();if(0===e.connects.length||h(e.connects)){if(-1==["ask","paranoid"].indexOf(g.values.connect_mode))return l.Breach();if(h(e.blockers))return l.Breach("URL was permanently blocked by the user");if(C){p.debug('cor: queuing access permission check from "'+c.name+'" to',d,b);var k=l();r.push({tabId:b.tab?b.tab.id:null,fn:function(){k.consume(F.apply(this,n))}});return k.promise()}return v(c,
b,e,d,f).then(function(a){return!0===a.approved?l.Pledge():l.Breach("Request was blocked by the user")})}return l.Breach("URL is not a part of the @connect list")})};return{getSessionConnects:function(a){return b[a]||[]},setSessionConnects:function(a,c){b[a]=c||[]},purgeAppeals:function(a){r=r.filter(function(c){return c.tabId!==a})},exec:function(a,c,b,d){var k,m,f,e=a.url,h=[],n=Math.max(Math.min(a.timeout||0,6E4),2E4),D=function(){for(var a;!m&&!f&&(a=h.shift());)a()},g=function(c,b){var k='Refused to connect to "'+
(b||a.url)+'": '+(c||"Blocked by @connect CORS check"),m=la.makeErrorResponse(k);["onerror","ondone"].forEach(function(a){if(d[a])d[a]({response:m,exception:k})})};if(!(b&&b.url&&b.tab&&a.url&&c&&(k=y.getByUid(c))&&k.script&&k.cond))return g();F(k.script,b,a.url,n).done(function(){var c={};Object.keys(d).forEach(function(a){c[a]=function(v){var C=arguments;m||(f?h.push(function(){c[a].apply(this,C)}):function(){return v&&v.finalUrl&&e!==v.finalUrl?(f=!0,F(k.script,b,v.finalUrl,n).fail(function(){m||
(r&&r.abort(),m=!0,g("Request was redirected to a not whitelisted URL",v.finalUrl),p.warn("cor: request to",e,"was redirect to a not whitelisted URL",v.finalUrl))}).always(function(){e=v.finalUrl;f=!1;h.length&&window.setTimeout(D,1)})):{always:function(a){a()}}}().always(function(){if(!m)d[a]({response:v})}))}});var r=ga(a,c)}).fail(function(a){g(a);p.warn("cor: access to",e,"was denied")})}}}(),ma=function(){var b=function(a){var c=[];a=new DataView(a);for(var b=0;b<a.byteLength;b+=4){var d=("00000000"+
a.getUint32(b).toString(16)).slice(-8);c.push(d)}return c.join("")},e={md5:function(a,c){return l.Pledge(K.MD5(a,c))}},d={};["SHA-1","SHA-256","SHA-384","SHA-512"].forEach(function(a){var c=a.toLowerCase().replace("-","");d[c]=function(){var c=function(c,d){var k=l();window.crypto.subtle.digest(a,K.str2arrbuf(c,d)).then(function(a){k.resolve(b(a))},function(){k.reject()});return k.promise()};try{return c("").then(function(a){if(a&&a.substr(0,4).toLowerCase().match(/[0-9a-f]{4,4}/))return c})}catch(d){return l.Breach()}}});
var f=function(a){return-1!=Object.keys(e).indexOf(a)},h=function(a){return function(){if(!1!==c){var b=arguments,d=l();c.push(function(){d.consume(a.apply(this,b))});return d.promise()}return a.apply(this,arguments)}},c=[];return{init:function(){p.D&&Object.keys(e).forEach(function(a){p.debug("sri:",a,"is supported")});return l.sidebyside(Object.keys(d).map(function(a){return d[a]().done(function(c){p.debug("sri:",a,"is supported");e[a]=c}).fail(function(){p.debug("sri:",a,"is unsupported")})})).always(function(){c.forEach(function(a){a()});
c=!1})},isSupported:h(function(a){return l.Pledge(f(a))}),getHash:h(function(a,c){var b=l();"string"===typeof a&&(a=A.parse(a));if(a&&a.hash){for(var d,e,h=a.hash.replace(/^#/,"").split(/,|;/g),n=0;n<h.length;n++)(e=h[n].match(/(.*)[=|:](.*)/))&&3==e.length&&f(e[1])&&(d={type:e[1],value:e[2]});b.resolve(d||(c?d:{type:"unsupported",value:""}))}else b.resolve();return b.promise()}),check:h(function(a,c,b){return c&&a&&f(a.type)?e[a.type](c,b).then(function(c,b){return((b=c===a.value)?l.Pledge:l.Breach)(b||
{type:a.type,value:c})}):l.Breach()})}}(),O=function(){var b={key:function(a,c){return q.CONSTANTS.PREFIX.EXTERNAL+u.select([a,c?K.MD5(c):null],function(a){return a}).join(":")},list:function(a){var c=new RegExp("^"+a);return u.select(t.listValues(),function(a){return-1!=a.search(c)})},set:function(a,c,d){a=b.key(a,c);var f={};u.each(d,function(a,c){"content"==c&&(c="base",a=K.encodeS(a));f[c]=a});t.setValue(a,{ts:Date.now(),url:c,resource:f})},get:function(a,c){var d=b.key(a,c),d=t.getValue(d),f;
if(d&&d.resource){var e={};u.each(d.resource,function(a,c){"base"==c&&(c="content",a=K.decodeS(a));e[c]=a});f={ts:d.ts,url:d.url,data:e}}return f},clean:function(a,c){var d=b.key(a,c);t.deleteValue(d)},cleanAll:function(a,c){var d,f=b.list(b.key(a));if(c){var e={};u.each(c,function(c){c=b.key(a,c);e[c]=!0});d=[];u.each(f,function(a){e[a]||d.push(a)})}else d=f;d.forEach(function(a){t.deleteValue(a)})}},e=function(a,c){var b=l(),d={method:"GET",url:a,retries:q.XMLHTTPREQUEST.RETRIES,nocache:!1,responseType:c.via_arraybuffer?
"arraybuffer":void 0},f=function(d){var f={content:""};if(4!=d.readyState||200!=d.status&&0!=d.status||d.error)b.reject(f);else{for(var e,h=d.responseHeaders?d.responseHeaders.split("\n"):[],n=0;n<h.length;n++){var D=h[n].split(":"),g=D.shift()||"",D=D.join(":")||"";if("content-type"==g.trim().toLowerCase()&&-1!=D.search("image")){e=D.trim();break}}if(!e){var r;a.match(".*.(ico|jpg|jpeg)+($|\\?|#).*")?e="image/x-icon":(r=a.match(".*.(gif|png)+($|\\?|#).*"))?e="image/"+r[1]:-1!=a.search(".js")?e="text/javascript":
(r=a.match(".*.(css|html|xml)+($|\\?|#).*"))?e="text/"+r[1]:u.isLocalImage(a)&&(e="image/x-icon")}f.meta=e;f.content=c.via_arraybuffer?K.arrbuf2str(d.response,c.encoding):d.responseText;b.resolve(f)}},e=function(){b.reject({})};c.sync?f(S(d,{})):(d.timeout=g.values.require_timeout,S(d,{onload:f,onerror:e,ontimeout:e}));return b.promise()},d=u.getDebouncer(9E3),f=function(a,c,d){d.no_storage=!0;h(a,c,d).done(function(d){b.set(a,c,d.resource)}).fail(function(b){p.warn("externals: update.failed :(",
a,c,b)}).always(function(){var d=b.get(a,c);d&&d.data?b.set(a,c,d.data):p.warn("externals: should never happen!")})},h=function(a,c,k){var h=l(),C=A.parse(c),r={sync:k.sync},v;ma.getHash(C,"supported"==g.values.require_sri_mode).done(function(l){if(c)if(Q.getEvilnessOf(c)>=g.values.script_blacklist_severity)r.resource={blacklisted:!0,content:""},h.reject(r);else if("enforce"!=g.values.require_sri_mode||l)if(!k.no_storage&&"file:"!==C.protocol&&(v=b.get(a,c))){var z=b.key(a,c),t=Date.now();0<g.values.external_update_interval&&
t-v.ts>g.values.external_update_interval&&!d.is(z)&&(1<g.values.external_update_interval&&d.add(z),p.debug("externals: resource needs update",c,(new Date(v.ts)).toISOString(),(new Date(t)).toISOString()),window.setTimeout(function(){f(a,c,k)},3E3));r.resource=v.data;r.resource.forbidden||r.resource.blacklisted?h.reject(r):h.resolve(r)}else r.sync=!1,"file:"==C.protocol&&-1==c.search(q.REQUESTS.GET_INTERNAL_PATH_REGEXP(!0))?(q.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||p.warn("externals: Access to local files is forbidden! Loading the following @resource may fail:",
c,"-> more info:","http://tampermonkey.net/faq.php#Q204"),z=ta.getSource({url:c,encoding:k.encoding})):z=e(c,{via_arraybuffer:k.via_arraybuffer,encoding:k.encoding}),z.done(function(d){l&&(d.sri=l);var f=function(d){!k.no_storage&&C.protocol&&"file:"!==C.protocol&&-1==c.search(q.REQUESTS.GET_INTERNAL_PATH_REGEXP(!0))&&b.set(a,c,d)};l&&-1!=["supported","given"].indexOf(g.values.require_sri_mode)?ma.check(l,d.content,k.encoding).done(function(){r.resource=d;f(r.resource);h.resolve(r)}).fail(function(a){r.resource=
{forbidden:!0,sri:{mode:g.values.require_sri_mode,type:l.type,value:"invalid"},determined:a,content:""};f(r.resource);h.reject(r)}):(r.resource=d,f(r.resource),h.resolve(r))}).fail(function(b){p.debug("externals: get.failed",a,c,b);r.resource={failed:!0,content:""};h.reject(r)});else r.resource={forbidden:!0,sri:{mode:g.values.require_sri_mode},content:""},h.reject(r);else r.resource={forbidden:!0,content:""},h.reject(r)});return h.promise()},c={getElement:function(a,c){return b.get(a,c)},cleanElement:function(a,
c){return b.clean(a,c)},dropAll:function(a){b.cleanAll(a);return l.Pledge()},dropAllBut:function(a,c){b.cleanAll(a,c);return l.Pledge()},loadResources:function(a,b){var d=l();c.getResources(a,b).always(function(){d.resolve()});return d.promise()},loadRequires:function(a,b){var d=l();c.getRequires(a,b).always(function(){d.resolve()});return d.promise()},getResources:function(a,c){var b={elements:[]},d=l(),f=[],e={via_arraybuffer:!0,sync:!0};c.forEach(function(c){var d=c.url||A.sanitize(c.unsafe_url,
c.abs_url),m={name:c.name,url:d},d=h(a,d,e),n=l();d.done(function(a){a=a.resource;m.content=a.content;m.meta=a.meta||"application"}).fail(function(a){a.resource&&a.resource.forbidden?a.resource.sri?p.warn("externals: can't load @resource",c.name,"from URL",c.unsafe_url,"due to a SRI error"):p.warn("externals: can't load @resource",c.name,"from forbidden URL",c.unsafe_url):a.resource&&a.resource.blacklisted?p.warn("externals: can't load @resource",c.name,"from blacklisted URL",c.unsafe_url):(p.warn("externals: can't load @resource",
c.name,"from URL",c.unsafe_url),m.failed=!0);m.content=null}).always(function(a){e.sync&=a.sync;b.elements.push(m);n.resolve()});f.push(n)});l.when(f).always(function(){b.sync=e.sync;d.resolve(b)});return d.promise()},getRequires:function(a,c){var b={elements:[]},d=l(),f=[],e={encoding:"UTF-8",sync:!0};u.each(c,function(c,d){var m=c.url||A.sanitize(c.unsafe_url,c.abs_url),n={},m=h(a,m,e),g=l();m.done(function(a){n.textContent=a.resource.content||""}).fail(function(a){a.resource&&a.resource.forbidden?
a.resource.sri?(n.textContent="// this @require's (\""+encodeURIComponent(c.unsafe_url)+'") SRI check failed!\n',p.warn("externals: can't load @require from URL",c.unsafe_url,"due to a SRI error")):(n.textContent='// this @require ("'+encodeURIComponent(c.unsafe_url)+'") is not allowed!\n',p.warn("externals: can't load @require from forbidden URL",c.unsafe_url)):a.resource&&a.resource.blacklisted?(n.textContent='// this @require ("'+encodeURIComponent(c.unsafe_url)+'") is blacklisted!\n',p.warn("externals: can't load @require from blacklisted URL",
c.unsafe_url)):(n.textContent='// this @require ("'+encodeURIComponent(c.unsafe_url)+'") could not be loaded!\n',p.warn("externals: can't load @require from URL",c.unsafe_url))}).always(function(a){e.sync&=a.sync;b.elements[d]=n;g.resolve()});f.push(g)});l.when(f).always(function(){b.sync=e.sync;b.elements=b.elements.filter(function(a){return a});d.resolve(b)});return d.promise()}};return c}();exts=O;var sa=function(){var b=function(b,d,f){var e=l(),c=[];f.forEach(function(a){a=a.textContent||"";
a=ha.mkCompat(a,b.options.compatopts_for_requires?b:null,"off"!=g.values.runtime_strict_mode);c.push(a)});f="\n"+c.join("\n")+"\n";var a=y.getStorageByUid(b.uuid);d=ha.mkCompat(d,b,"off"!=g.values.runtime_strict_mode);if(g.values.debug){d=d.split("\n");for(var m=!1,k,D=0;D<d.length;D++)if(k=d[D],!k.match(/^\s*$|^\s*\/\/\s*|^\s*\/\*.*\*\/\s*$|^\s*["']+use strict["']+;*\s*$/))if(k.match(/^\s*\/\*/)&&(m=!0),m)if(k.match(/\*\/\s*$/))m=!1;else{if(-1!=(k=k.search(/\*\//))){d[D]=u.insert(d[D],k+2,0,"debugger;");
break}}else{d[D]="debugger;"+d[D];break}d=d.join("\n")}e.resolve({header:b.header,code:d,requires:f,storage:a,script:b});return e.promise()};return{bundle:function(e,d,f){var h={},c="includes matches requires resources excludes connects textContent".split(" ");Object.keys(d).forEach(function(a){-1==c.indexOf(a)&&("options"==a?(h[a]=JSON.parse(JSON.stringify(d[a])),h[a].run_at=h[a].run_at||d.options.override.orig_run_at||"document-idle"):h[a]=d[a])});return O.getResources(h.uuid,d.resources).then(function(a){f&&
!a.sync&&(p.debug("ri: uncached @external detected -> fast script start disabled"),f=a.sync);h.resources=a.elements;return O.getRequires(h.uuid,d.requires)}).then(function(a){f&&!a.sync&&(p.debug("ri: uncached @external detected -> fast script start disabled"),f=a.sync);a=a.elements;p.debug("run script "+h.name+" @ "+e.url);return b(h,d.textContent,a)})}}}(),va=function(){var b=rea.extension.getViews({type:"popup"});b&&b.length&&rea.extension.sendMessage({method:"updateActions"},function(){})},W=
function(){return{getConfig:function(){var b={version:0,last:0},e={scripts:0},d=t.getValue(q.CONSTANTS.STORAGE.UPDATE,e);"object"!==typeof d&&(d=e);d||(d=e);void 0==d.black&&(d.black=b);void 0==d.scripts&&(d.scripts=0);return d},setConfig:function(b){b&&t.setValue(q.CONSTANTS.STORAGE.UPDATE,b)}}}(),X=function(){var b=function(b,h){var c=0,a=0;if(b){var m=e.getMessage("Script_Update"),k=e.getMessage("Check_for_userscripts_updates")+"...";P.show(m,k,rea.extension.getURL("images/icon128.png"),1E4)}m=
y.getUidList().map(function(b){var k,f,m,n,z,t;p.info("update: check for script updates @",b);return function(){n=y.getByUid(b);if(!n.script||!n.cond)return p.warn("update: inconsistent script entry",b,n),l.Breach();var a=!g.values.scriptUpdateCheckDisabled&&!n.script.enabled&&!h;return h&&n.script.uuid!==h||a||!(t=w.determineSourceURL(n.script))?l.Breach():l.Pledge()}().then(function(){var a=w.determineMetaURL(n.script);if(!a)return l.Pledge();var c=l();ga({method:"GET",retries:q.XMLHTTPREQUEST.RETRIES,
timeout:1E3*q.SCRIPT_DOWNLOAD.TIMEOUT,nocache:!0,headers:{Accept:"text/x-userscript-meta, */*"},url:a},{ondone:function(b){4==b.readyState&&200==b.status?z=x.processMetaHeader(b.responseText):p.warn("update: unable to find meta data @ "+a+" req.status = "+b.status);c.resolve()}});return c.promise()}).then(function(){var a=!!z,c=a&&!!z.version,b=c&&(!n.script.version||x.versionCmp(z.version,n.script.version)==x.versionCmp.eNEWER);return a&&c&&!b?l.Breach():l.Pledge()}).then(function(){return d.getScriptFromURL(t).fail(function(){p.warn("update: failed",
n.script.name,t)})}).then(function(a){var b;var d=n.script.uuid;b=x.createScriptFromSrc(a);b=b.name&&""!=b.name&&void 0!==b.version?(d=y.getMetaByUid(d))&&d.system?null:b.options.compat_uW_gmonkey?x.versionCmp.eERROR:-1!=b.name.search("@")?x.versionCmp.eERROR:d&&b.version==d.version?x.versionCmp.eEQUAL:d&&x.versionCmp(b.version,d.version)==x.versionCmp.eOLDER?x.versionCmp.eOLDER:x.versionCmp.eNEWER:x.versionCmp.eERROR;return b==x.versionCmp.eNEWER?(c++,k=n.script.name,f=t,m=a,l.Pledge()):l.Breach()}).then(function(){if(g.values.notification_silentScriptUpdate)return l.Pledge();
var a=e.getMessage("There_is_an_update_for_0name0_avaiable_",k)+"\n"+e.getMessage("Click_here_to_install_it_"),c=e.getMessage("Just_another_service_provided_by_your_friendly_script_updater_")+":",b=l();P.show(c,a,rea.extension.getURL("images/icon128.png"),g.values.scriptUpdateHideNotificationAfter,b.resolve);return b.promise()}).then(function(c){var d=b||n.script.uuid;return void 0===c||c.clicked?w.doSave({url:f,uuid:d,replace:!d,src:m,ask:!g.values.notification_silentScriptUpdate}).done(function(c){c&&
c.installed&&a++}):l.Breach()})});return l.sidebyside(m).then(function(){0==c&&b&&(p.debug("No update found"),P.show("Narf!",e.getMessage("No_update_found__sry_"),rea.extension.getURL("images/icon128.png"),1E4));return{found:c,installed:a}})},n=null,d={check:function(d,h,c){if(!d&&0>=g.values.scriptUpdateCheckPeriod)return l.Breach();var a=W.getConfig();if(!d&&Date.now()-a.scripts<Math.max(g.values.scriptUpdateCheckPeriod,36E5))return l.Breach();var m=l();d=function(){k&&(window.clearTimeout(k),k=
null);n&&n.cancel();b(h,c).done(function(a){m.resolve(a.installed)}).fail(function(){m.resolve(null)});a=W.getConfig();a.scripts=Date.now();W.setConfig(a)};var k,n,p=function(){n=null;var a=e.getMessage("Script_Update"),c=e.getMessage("Waiting_for_sync_to_finish")+"...";n=P.show(a,c,rea.extension.getURL("images/icon128.png"),6E4)};H.enabled?(H.addSyncDoneCallback(d),H.sync(50,!1),h&&(k=window.setTimeout(p,500))):d();return m.promise()},getScriptFromURL:function(b){var d=l();S({method:"GET",retries:q.XMLHTTPREQUEST.RETRIES,
timeout:1E3*q.SCRIPT_DOWNLOAD.TIMEOUT,nocache:!0,headers:{Accept:"text/x-userscript, */*"},url:b},{onload:function(c){4!=c.readyState||200!=c.status&&0!=c.status||c.error?d.reject():d.resolve(c.responseText)},onerror:function(c){d.reject({error:!0,responseText:c.responseText})},ontimeout:function(){d.reject({timeout:!0,responseText:""})}});return d.promise()},init:function(){var b=function(){n&&(window.clearTimeout(n),n=null);0<g.values.scriptUpdateCheckPeriod&&(n=window.setTimeout(function(){n=null;
d.check();b()},36E5))};b();g.addChangeListener("scriptUpdateCheckPeriod",b)}};return d}();trup=X;var w=function(){var b=function(c){c.sort(function(a,c){return a.position-c.position});return c},n=function(c){void 0===c.ask&&(c.ask=!0);if(void 0===c.url||null==c.url)c.url="";""===c.force_url&&(c.force_url=null);var a=x.createScriptFromSrc(c.src),b=null,d={heading:null,errors:[],info:[],warnings:[],flags:{}},f=l(),n=Date.now(),r=c.save&&!c.ask&&g.values.editor_easySave,v=c.uuid,F;a.name&&void 0!=a.version?
F=l.Pledge():(d.errors.push(e.getMessage("Invalid_UserScript__Sry_")+"\n\n"),c.name&&d.errors.push(e.getMessage("Script_name_0name0",c.name)+"\n\n"),c.url&&d.errors.push(e.getMessage("Downloaded_from_0url0",c.url)),p.warn("scriptman: invalid userscript",d,a),F=l.Breach());F.then(function(){c.replace&&!v&&(v=y.getUidsByName(a.name,a.namespace)[0]);if(v)b=y.getMetaByUid(v);else if(a.uuid)v=a.uuid;else if(c.replace)v=u.createUUID();else return p.warn("scriptman: neither UUID, @uuid nor replace option set"),
l.Breach();if(""!==v.replace(/[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}/,""))return p.warn("scriptman: invalid UUID",v),l.Breach();if(!c.clean&&!c.defaultscript&&b&&b.system)return l.Breach()}).then(function(){if(c.clean&&c.name&&c.name!=a.name||-1!=a.name.search("\n"))return d.errors.push(e.getMessage("Invalid_UserScript_name__Sry_")),l.Breach()}).then(function(){if(a.options.compat_uW_gmonkey)return d.errors.push(e.getMessage("This_script_uses_uW_gm_api_")),l.Breach()}).then(function(){if(b){b.name!=
a.name&&(d.flags.renamed=!0);if(b.lastModified&&void 0!==c.lastModified&&b.lastModified!==c.lastModified){var f=e.getMessage("some_secs");try{var h=Math.max(1,Math.floor((n-b.lastModified)/1E3));isNaN(h)||(f=h)}catch(g){}d.warnings.push(e.getMessage("CONFLICT__This_script_was_modified_0t0_seconds_ago_",f));d.flags.forceAsk=!0}a.version==b.version&&(c.save?d.flags.modification=!0:d.flags.reset=!0);c.clean&&(d.flags.factory=!0)}else d.flags.first_install=!0;if(!(a.includes.length||a.matches.length||
r||c.internal))return d.errors.push(e.getMessage("This_script_does_not_provide_any__include_information_")),l.Breach();d.flags.sync=!!c.sync;d.flags.internal=c.internal;d.flags.ask=c.ask}).then(function(){a.uuid=v;a.system=c.defaultscript;a.evilness=w.getEvilness(a);a.position=w.determineLastPosition()+1;a.lastUpdated=c.force_meta&&c.force_meta.lastUpdated||n;d.flags.factory||d.flags.reset?b&&(a.lastUpdated=b.lastUpdated):(c.force_url&&(a.updateURL=null,a.downloadURL=c.force_url),b&&(a.options.override=
b.options.override,a.options.comment=b.options.comment));["includes","excludes","matches","connects"].forEach(function(c){a.options.override["orig_"+c]=a[c]});a.options.override.orig_noframes=a.options.noframes;a.options.override.orig_run_at=a.options.run_at||"document-idle";a.options.noframes=null;a.options.run_at=null}).then(function(){if(b&&(a.fileURL=b.fileURL,a.position=b.position,b.sync&&(a.sync=b.sync),!d.flags.factory&&!d.flags.reset)){a.enabled=b.enabled;a.options.noframes=b.options.noframes;
a.options.run_at=b.options.run_at;a.options.awareOfChrome||(a.options.compat_forvarin=b.options.compat_forvarin);c.save&&!c.force_url&&(a.downloadURL=b.downloadURL||a.downloadURL);var f=h.determineMetaURL(b),n=h.determineMetaURL(a),f=f?A.woHash(f):f,n=n?A.woHash(n):n;f==n||r||c.internal||d.warnings.push(e.getMessage("The_update_url_has_changed_from_0oldurl0_to__0newurl0",[f,n]))}}).then(function(){if(b&&!d.flags.factory&&a.version==b.version&&(c.defaultscript||c.noreinstall))return l.Breach()}).then(function(){b?
(d.flags.factory||d.flags.reset?(d.flags.reset?(d.heading=e.getMessage("You_are_about_to_reinstall_a_UserScript_"),d.flags.reinstall=!0):(d.heading=e.getMessage("You_are_about_to_install_a_UserScript_"),d.flags.install=!0),c.internal||d.warnings.splice(0,0,e.getMessage("All_script_settings_will_be_reset_"))):d.flags.modification?d.heading=e.getMessage("You_are_about_to_modify_a_UserScript_"):x.versionCmp(a.version,b.version)==x.versionCmp.eOLDER?(d.heading=e.getMessage("You_are_about_to_downgrade_a_UserScript"),
d.flags.downgrade=!0,r||c.internal||d.warnings.splice(0,0,e.getMessage("The_downgraded_script_might_have_problems_to_read_its_stored_data_"))):(d.heading=e.getMessage("You_are_about_to_update_a_UserScript_"),d.flags.update=!0),d.info.push({label:e.getMessage("Installed_Version_"),value:"v"+b.version})):(d.heading=e.getMessage("You_are_about_to_install_a_UserScript_"),r||c.internal||(d.info.splice(0,0,e.getMessage("Malicious_scripts_can_violate_your_privacy_")),Q.getWarningsFor(h.determineSourceURL(a)).forEach(function(a){d.warnings.splice(0,
0,a)})),d.flags.install=!0);d.flags.install?d.action=e.getMessage("Install"):d.flags.reinstall?d.action=e.getMessage("Reinstall"):d.flags.modification?d.action=e.getMessage("Modify"):d.flags.downgrade?d.action=e.getMessage("Downgrade"):d.flags.update&&(d.action=e.getMessage("Update"))}).then(function(){c.url&&(a.fileURL=c.url);c.sync&&(a.sync=c.sync);c.force_options&&u.copy(c.force_options,a.options,(new x.Script).options,!0);c.force_settings&&u.copy(c.force_settings,a,["enabled","position"]);a=w.mergeCludes(a)}).then(function(){var c=
!1,b;for(b in a.options)if(-1!=b.search("compat_")&&!0===a.options[b]){c=!0;break}c&&d.info.push({label:e.getMessage("Note"),value:e.getMessage("A_recheck_of_the_GreaseMonkey_FF_compatibility_options_may_be_required_in_order_to_run_this_script_")})}).then(function(){["requires","resources"].forEach(function(c){a[c]=u.map(a[c],function(c){c.unsafe_url=c.url;c.abs_url=a.fileURL?a.fileURL.split("/").slice(0,-1).join("/"):null;c.url=null;return c})})}).done(function(){f.resolve({script:a,messages:d,short_info:[{label:e.getMessage("Author"),
prop:"author"},{label:e.getMessage("Description"),prop:"description"},{label:e.getMessage("Source"),prop:"fileURL"}]})}).fail(function(){f.reject({messages:d})});return f.promise()},d=function(c){var a=l(),b=c.messages,d=c.script,f=!b.flags.internal,e=function(){var a=h.doModify(d.uuid,d,f)||{};b.flags.modification||O.dropAll(d.uuid);(b.flags.first_install||b.flags.factory)&&y.setStorageByUid(d.uuid,{ts:Date.now()});return a},n={lastModified:void 0,installed:!0,renamed:b.flags.renamed};b.warnings.length||
b.flags.ask?ba.install(c).done(function(c){c.ok&&e();n.installed=c.ok;n.aborted=c.aborted;a.resolve(n)}).fail(function(c){a.reject(c)}):(e(),a.resolve(n));return a.promise()},f=u.getDebouncer(1E3),h={determineSourceURL:function(c){return c?u.select([c.downloadURL,c.fileURL],function(a){if(!a||"file:"!==A.parse(a).protocol)return a})[0]:null},determineMetaURL:function(c){if(!c)return null;var a,b=w.determineOrigin(c);b&&b.meta_header?a=c.fileURL:!c.fileURL||b&&!b.meta_url||(a=c.fileURL.replace(".user.js",
".meta.js"),c.fileURL==a&&(a=c.fileURL.replace(".tamper.js",".meta.js")),c.fileURL==a&&(a=null));return u.select([c.updateURL,c.downloadURL,a],function(a){if(!a||"file:"!==A.parse(a).protocol)return a})[0]},mergeCludes:function(c){var a,b,d=c.options.override;["includes","excludes","matches"].forEach(function(a){c[a]=d["merge_"+a]&&d["orig_"+a]?d["orig_"+a].slice():[]});if(d.use_includes)for(a=0;a<d.use_includes.length;a++)b=c.excludes.indexOf(d.use_includes[a]),0<=b&&c.excludes.splice(b,1),c.includes.push(d.use_includes[a]);
if(d.use_matches)for(a=0;a<d.use_matches.length;a++)b=c.excludes.indexOf(d.use_matches[a]),0<=b&&c.excludes.splice(b,1),c.matches.push(d.use_matches[a]);if(d.use_excludes)for(a=0;a<d.use_excludes.length;a++)c.excludes.push(d.use_excludes[a]);return c},doSave:function(c){return n(c).then(d)},doRemove:function(c,a){y.removeByUid(c,a);y.setStorageByUid(c,null);O.dropAll(c);return l.Pledge()},doModify:function(c,a,b){void 0===b&&(b=!0);y.setByUid(c,a,b);return b?O.loadResources(c,a.resources).then(function(){return O.loadRequires(c,
a.requires)}).then(function(){var b=[].concat(a.resources).concat(a.requires).map(function(a){return A.sanitize(a.unsafe_url,a.abs_url)});return O.dropAllBut(c,b)}):l.Pledge()},exportToJson:function(c,a){var b=l(),d=w.determineScriptsToRun(null);c&&(d=u.select(d,function(a){return c[a.uuid]}));d=na(d,!0);a&&!a.storage||d.forEach(function(a){a.storage=y.getStorageByUid(a.uuid)});d={scripts:d};if(!a||a.global_settings)d.global_settings=t.getValue(q.CONSTANTS.STORAGE.CONFIG,{});b.resolve(d);return b.promise()},
importFromJson:function(c){if(!c||!c.scripts||!c.scripts.length)return l.Breach();for(var a={},b=[],f={},e=0,h;h=c.scripts[e];e++)try{var g=l();"new-user-script"!=h.uuid&&(h.storage&&(f[h.uuid]=h.storage),n({uuid:h.uuid,name:h.name,src:h.source,force_settings:{enabled:h.enabled,position:h.position},force_options:h.options,force_meta:{lastUpdated:h.lastModified},replace:!0,url:h.file_url||h.update_url,ask:!1}).done(function(c){a[u.createUUID()]=c;g.resolve()}).fail(function(a){p.warn("import: Error @ script",
h.name,a);g.resolve()}),b.push(g.promise()))}catch(F){p.warn("import: Error while importing script",h.name,F)}var v=function(){var a=l();l.when(b).always(function(){a.resolve()});return a.promise()}().then(function(){return ba.import(a,c.global_settings)}).then(function(c){var b=l(),e=[],h=[];if(c.ok)for(var n=0,m;m=c.import_ids[n];n++)(function(){var c=m;if(a[c]){a[c].messages.warnings=[];var b=d(a[c]).done(function(){var b;(b=a[c].script.uuid)&&f[b]&&(b=y.setStorageByUid(b,{data:f[b].data||{},ts:Date.now()}),
h.push(b))});e.push(b)}})();l.when(e).always(function(){w.reorderScripts();l.when(h).always(function(){b.resolve(c)})});return b.promise()}).then(function(a){return c.global_settings&&a.global_settings?(a=t.setValue(q.CONSTANTS.STORAGE.CONFIG,c.global_settings).then(function(){v.done(function(){window.setTimeout(T.reset,1)});return l.Pledge({global_settings:!0})}),t.setTemporary(!0),a):l.Pledge({})});return v},installFromUrl:function(c,a,b){var d=l(),n=A.parse(c),g={messages:{errors:[e.getMessage("Unable_to_load_script_from_url_0url0",
c)],warnings:[]}};a=a||{};b=b||{};var r=[c,JSON.stringify(a)].join("_");if(f.is(r))return p.debug("scriptman: de-bounced installFromUrl",c),l.Breach();f.add(r);if(!n.protocol.match(/(https?|file):/))return p.warn("scriptman: can't install from ",c),l.Breach(g);"file:"!=n.protocol||q.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||p.warn("scriptman: Access to local files is forbidden! Loading the following script for installation may fail:",c,"-> more info:","http://tampermonkey.net/faq.php#Q204");var v=function(a,
c){if(!a)if(c)a=g,"file:"!=n.protocol||q.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||a.messages.warnings.unshift(e.getMessage("Tampermonkey_has_no_file_access_permission_"));else{d.reject();return}a.heading=e.getMessage("You_are_about_to_install_a_UserScript_");b.silent_fail?d.reject(a):ba.installError(a).always(function(a){d.reject(a)})};X.getScriptFromURL(c).done(function(b){var f={url:c,src:b,ask:!0,replace:!0};a&&u.each(a,function(c,b){f[b]=a[b]});h.doSave(f).done(function(a){d.resolve(a.installed)}).fail(v)}).fail(function(a){v(null,
a)});return d.promise()},determineLastPosition:function(){var c=0;y.getUidList().forEach(function(a){var b=y.getByUid(a);b.script&&b.cond?b.script.position&&b.script.position>c&&(c=b.script.position):p.warn("scriptman: inconsistent script entry",a)});var a=new x.Script;a.position>c&&(c=a.position);return c},convertToRegExp:function(c,a){var b,d;try{!a&&1<c.length&&"/"==c.substr(0,1)?b=new RegExp(".*"+c.replace(/^\//g,"").replace(/\/$/g,"")+".*","i"):a?(d=A.getRegExpFromMatch(c),b=new RegExp(d)):(d=
A.getRegExpFromInclude(c),b=new RegExp(d,"i"))}catch(f){return p.warn("scriptman: invalid regexp ",c),!1}return b},matchUrl:function(c,a){return""===c.replace(a,"")},regexify:function(c,a){var b={},d={inc:"rinc",match:"rinc",exc:"rexc"};Object.keys(d).forEach(function(f){var e=c[f]&&c[f].length?c[f].map(function(a){return h.convertToRegExp(a,"match"===f)}).filter(function(a){return!1!==a}):null;if(e||a)b[d[f]]=(b[d[f]]||[]).concat(e||[])});return b},validUrl:function(c,a,b){var d=!1;if(a.rinc){if(a.rinc.every(function(a){return h.matchUrl(c,
a)?(p.debug('scriptman: @include "'+a+'" matched'+(b?" ("+b+")":'"')),d=!0,!1):!0}),!d)return d}else d=!0;a.rexc&&a.rexc.every(function(a){return h.matchUrl(c,a)?(p.debug('scriptman: @exclude "'+a+'" matched'+(b?" ("+b+")":'"')),d=!1):!0});return d},getEvilness:function(c){var a=0;return c.fileURL&&(a=Q.getEvilnessOf(c.fileURL))||c.downloadURL&&(a=Q.getEvilnessOf(c.downloadURL))||c.updateURL&&(a=Q.getEvilnessOf(c.updateURL))?(p.debug("scriptman: found blacklisted script",c),a):0},blackCheckAll:function(){y.getUidList().forEach(function(c){var a=
y.getByUid(c);if(a.script&&a.cond){var b=w.getEvilness(a.script);if(b!==a.script.evilness){if(b||void 0!==a.script.evilness)p.debug("scriptman: write blacklist state of ",a.script.name,b),b&&L.tS(a.script.name,b,"b");a.script.evilness=b;h.doModify(c,a.script,!1)}}})},reorderScripts:function(c,a){var d=h.determineScriptsToRun();if(c)for(var f=0;f<d.length;f++){var e=d[f];e.uuid==c&&(e.position=Number(a)+(e.position<a?.5:-.5))}d=b(d);f=1;for(e=0;e<d.length;e++){var n=d[e];n.position=f++;h.doModify(n.uuid,
n,!1)}},getUniqueScriptsForTab:function(c){var a=[];B.get.empty(c.id)?p.debug("bg: WARN: Tabs.get.urls["+c.id+"] is empty!"):u.each(B.get.urls(c.id),function(c,b){if(ca.isAllowed(b))for(var d=w.determineScriptsToRun(b),f=0;f<d.length&&(0===c.frameId||!0!==d[f].options.noframes&&(null!==d[f].options.noframes||!0!==d[f].options.override.orig_noframes));f++){for(var e=!1,h=0;h<a.length;h++)if(a[h].uuid==d[f].uuid){e=!0;break}e||a.push(d[f])}});return a},determineScriptsToRun:function(c){var a=[];p.debug("scriptman: determineScriptsToRun @"+
c);y.getUidList().forEach(function(b){if(c){var d=J.items.regexp.get(b);if(!d){if(!(d=t.getValue(q.CONSTANTS.PREFIX.COND+b,null)))return;d=h.regexify(d,!0);J.items.regexp.set(b,d)}if(!h.validUrl(c,d,b))return}d=y.getByUid(b);d.script&&d.cond?a.push(d.script):p.warn("scriptman: inconsistent script entry",b,d)});return b(a)},isContexter:function(c){return c.options&&("context-menu"===c.options.run_at||null===c.options.run_at&&"context-menu"===c.options.override.orig_run_at)},determineOrigin:function(c){return h.determineOriginOfUrl(c.fileURL||
c.downloadURL||c.updateURL)},determineOriginOfUrl:function(c){if(c){var a=c.match(/https?:\/\/userscripts\.org\/scripts\/(source|version)\/([0-9]{1,9})\.user\.js/)||c.match(/https?:\/\/userscripts-mirror\.org\/scripts\/(source|version)\/([0-9]{1,9})\.user\.js/);if(a&&3==a.length)return{id:a[2],token:"uso",meta_url:!0,url:"http://userscripts-mirror.org/scripts/show/"+a[2],issue_url:"http://contactbyweb.com/userscripts-mirror"};if((a=c.match(/https?:\/\/greasyfork\.org\/scripts\/([^/]+)\/code\/.*\.user\.js/))&&
2==a.length)return{id:a[1],token:"gf",meta_url:!0,url:"https://greasyfork.org/scripts/"+a[1],issue_url:"https://greasyfork.org/scripts/"+a[1]+"/feedback"};if((a=c.match(/https?:\/\/openuserjs\.org\/install\/([^/]+)+\/(.*)\.user\.js/))&&3==a.length)return a.shift(),{id:a.join("/"),token:"ouj",meta_header:!0,url:"https://openuserjs.org/scripts/"+a[0]+"/"+a[1],issue_url:"https://openuserjs.org/scripts/"+a[0]+"/"+a[1]+"/issues"};if((a=c.match(/https?:\/\/monkeyguts\.com\/(codepages\/)?([0-9]{1,9})\.user\.js/))&&
3==a.length)return{id:a[2],token:"mog",meta_url:!0,url:"https://monkeyguts.com/code.php?id="+a[2],issue_url:"https://monkeyguts.com/code.php?nav=rev&id="+a[2]};if((c=c.match(/https?:\/\/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)\/.*\.user\.js/)||c.match(/https?:\/\/github\.com\/([^/]+)\/([^/]+)\/raw\/.*\.user\.js/)||c.match(/https?:\/\/github\.com\/([^/]+)\/([^/]+)\/releases\/download\/.*\.user\.js/))&&3==c.length)return c.shift(),{id:c.join("/"),token:"gh",url:"https://github.com/"+c.join("/"),
issue_url:"https://github.com/"+c.join("/")+"/issues"}}}};return h}(),y=function(){var b=[],e={init:function(){t.addDifferentOriginChangeListener(q.CONSTANTS.PREFIX.STORE,function(b,f){if(f&&f.hasOwnProperty("value")&&f.origin){var h=b.replace(q.CONSTANTS.PREFIX.STORE,""),c;for(c in f.value.data)f.value.data.hasOwnProperty(c)&&function(){var a=c,b=f.value.data[c];e.notifyStorageListeners({uuid:h},null,function(c){var d={data:{},ts:0};d.data[a]=b;d.ts=f.value.data.ts;var e={storage:d};void 0===d.data[a]&&
(e.removed=a);c(e)})}()}})},getUidList:function(){var b=new RegExp("^"+q.CONSTANTS.PREFIX.SCRIPT_UID),f=[];t.listValues().forEach(function(e){-1!=e.search(b)&&f.push(e.replace(b,""))});return f},getUidsByName:function(b,f){var h=[];e.getUidList().forEach(function(c){var a=e.getMetaByUid(c);!a||a.name!=b||f&&f!=a.namespace||h.push(c)});return h},getUidByName:function(b){p.warn("sb: deprecated fn");return e.getUidsByName(b)[0]},getStorageByUid:function(b){b=t.getValue(q.CONSTANTS.PREFIX.STORE+b,{ts:0,
data:{}});"undefined"===typeof b.ts&&(b.ts=0);"undefined"===typeof b.data&&(b.data={});return b},setStorageByUid:function(b,f){return f?t.setValue(q.CONSTANTS.PREFIX.STORE+b,f):t.deleteValue(q.CONSTANTS.PREFIX.STORE+b)},getMetaByUid:function(b){return t.getValue(q.CONSTANTS.PREFIX.META+b,null)},getByUid:function(b){if(!b)return p.error("sb: no UUID set"),{};var f,e=t.getValue(q.CONSTANTS.PREFIX.META+b,null);if(e){var c=function(a){if(a)for(var c=0,b=null;b=a[c];c++)delete b.loaded,delete b.textContent,
delete b.resURL,delete b.resText};c(e.requires);c(e.resources);e.uuid=b;e.options.override.use_connects||(e.connects=e.connects||[],e.options.override.merge_connects=!0,e.options.override.use_connects=[]);e.grant=e.grant||[];e.textContent=t.getValue(q.CONSTANTS.PREFIX.SCRIPT+b,e.textContent);e.textContent&&(f=e)}return{script:f,cond:t.getValue(q.CONSTANTS.PREFIX.COND+b,null)}},setByUid:function(b,f,e){var c={};if(!b)return p.error("sb: no UUID set",f),c;if(null===f.textContent||void 0===f.textContent)throw Error("No script code set!");
var a=t.getValue(q.CONSTANTS.PREFIX.META+b),n=!a;t.setValue(q.CONSTANTS.PREFIX.SCRIPT_UID+b,f.name);t.setValue(q.CONSTANTS.PREFIX.COND+b,{inc:f.includes,match:f.matches,exc:f.excludes});t.setValue(q.CONSTANTS.PREFIX.SCRIPT+b,f.textContent);var k=u.copy(f,{});k.textContent=null;e&&(c.lastModified=Date.now(),k.lastModified=c.lastModified);t.setValue(q.CONSTANTS.PREFIX.META+b,k);e&&(ia.onScriptsChanged(),n?H.scriptAddedCb(f.name,f):H.scriptChangedCb(f.name,f,a),g.values&&L.tS(f.name,f.fileURL,n?"i":
"u"));J.items.rundata.removeAll();J.items.regexp.remove(b);return c},removeByUid:function(b,f){void 0===f&&(f=!0);var h=e.getByUid(b);t.deleteValue(q.CONSTANTS.PREFIX.SCRIPT_UID+b);t.deleteValue(q.CONSTANTS.PREFIX.COND+b);t.deleteValue(q.CONSTANTS.PREFIX.SCRIPT+b);t.deleteValue(q.CONSTANTS.PREFIX.META+b);t.deleteValue(q.CONSTANTS.PREFIX.STORE+b);f&&(ia.onScriptsChanged(),h.script&&h.cond&&(H.scriptRemovedCb(h.script.name,h.script),g.values&&L.tS(h.script.name,null,"r")));J.items.rundata.removeAll();
J.items.regexp.remove(b);return{}},addStorageListener:function(d,f,e,c,a){b.push({tabid:d,id:f,uuid:e,time:c,response:a})},removeStorageListeners:function(d,f){void 0===f&&(f=!0);var e=b;b=[];e.forEach(function(c){try{void 0!==d.tabid&&d.tabid!==c.tabid||void 0!==d.uuid&&d.uuid!==c.uuid||void 0!==d.id&&d.id!==c.id?b.push(c):f&&c.response({})}catch(a){p.debug("sb: listener clear for script",d,"failed! Page reload?!")}})},notifyStorageListeners:function(d,f,e){d=d||{};f=f||{};b.forEach(function(c){try{void 0!==
f.uuid&&c.uuid===f.uuid||void 0!==f.tabid&&c.tabid===f.tabid||void 0!==f.id&&c.id===f.id||void 0!==d.tabid&&d.tabid!==c.tabid||void 0!==d.uuid&&d.uuid!==c.uuid||void 0!==d.id&&d.id!==c.id||e&&e(c.response)}catch(a){p.warn("sb: listener notification for script",d,"failed! Page reload?!")}})}};return e}();scbr=y;var wa=function(){var b=function(b,d){var f=null,e=b.sender,c=this,a=function(a){try{b.postMessage(a)}catch(c){p.debug("bg: Error sending port ("+b.name+") message",a)}};if("xhr"==d.method){var m=
function(){b.disconnect()};d.details.convertBinary=!0;d.details.partialSize=d.details.partialSize||q.XMLHTTPREQUEST.PARTIAL_SIZE;var k={};Object.keys(d.callbacks).forEach(function(c){var b="ondone"===c;if(d.callbacks[c]||b||"onload"===c)k[c]=function(d){d={data:d.response,exception:d.exception};d[c]=!0;a(d);b&&m()}});k.ondone||(k.ondone=m);d.details.url=A.sanitize(d.details.url,d.url||e.url||null,["http:","https:"])||d.details.url;da.exec(d.details,d.uuid,e||{},k)}else if("download"==d.method)G.start(d.details,
{onload:function(c){a({load:!0,data:c})},onprogress:function(c){a({progress:!0,data:c})},onerror:function(c){a({error:!0,data:c})},ontimeout:function(c){a({timeout:!0,data:c})},ondone:function(){b.disconnect()}});else if("addStorageListener"==d.method)e.tab?(y.addStorageListener(e.tab.id,d.id,d.uuid,Date.now(),a),f=function(){y.removeStorageListeners({uuid:d.uuid,id:d.id},!1)}):a({error:!0});else if("saveStorageKey"==d.method)e.tab?d.uuid&&(e=y.getStorageByUid(d.uuid),e.data[d.key]=d.value,e.ts=d.ts,
y.setStorageByUid(d.uuid,e),y.notifyStorageListeners({uuid:d.uuid},{id:d.id},function(a){var c={data:{},ts:0};c.data[d.key]=d.value;c.ts=d.ts;var b={storage:c};void 0===c.data[d.key]&&(b.removed=d.key);a(b)})):p.warn("storage: unable to save storage due to empty tabID!"),a({});else if("openInTab"==d.method){var f=["active"],g={url:d.details.url};if(d.details.options){for(var l=0;l<f.length;l++)void 0!==d.details.options[f[l]]&&(g[f[l]]=d.details.options[f[l]]);d.details.options.insert&&(g.index=e.tab.index+
1)}f=function(){c.disconnected=!0;c.tabId&&delete V[c.tabId]};rea.tabs.create(g,function(b){c.tabId=b.id;V[b.id]={onClose:function(){a({close:!0})}};a({success:!0,tabId:b.id})})}else if("nameTab"==d.method){if(c.tabId){var r=3,v=function(){B.listeners.once.whenReady(c.tabId,function(){rea.tabs.sendMessage(c.tabId,{method:"setForeignAttr",attr:"name",value:d.name},function(c){c?a({name:d.name}):0<r--?v():p.warn("foreignAttr: error setting attr")})})};v()}}else"closeTab"==d.method?(c.tabId&&V[c.tabId]&&
rea.tabs.remove(c.tabId),a({}),window.setTimeout(function(){try{c.disconnected||b.disconnect()}catch(a){}c.disconnected=!0},1E3)):"registerMenuCommand"==d.method&&(e.tab?(Y.add(e.tab.id,d.name,d.accessKey,d.menuId,a),va(),f=function(){Y.clearById(d.menuId);va()}):(p.warn("Unable to register menu cmd due to empty tabID!"),b.disconnect()));f&&b.onDisconnect.addListener(f)};return function(e){if(E.late){var d={};e.onMessage.addListener(function(f){b.apply(d,[e,f])})}else E.registerLateCallback(function(){wa(e)})}}(),
aa={ping:{allow:{insecure:!0},exec:function(b,e,d){d({pong:!0,instanceID:ra,config:{layout:g.values.layout}})}},newTab:{allow:{extpage:!0},exec:function(b,e,d){rea.tabs.create({url:b.url},function(b){d({tabId:b.id})})}},getTab:{allow:{script:!0},exec:function(b,e,d){e.tab&&b.uuid?(N[e.tab.id]||(N[e.tab.id]={}),N[e.tab.id][b.uuid]||(N[e.tab.id][b.uuid]={}),d({data:N[e.tab.id][b.uuid]})):(p.warn("bg: unable to process request",e,b),d({data:null}))}},getTabs:{allow:{script:!0},exec:function(b,e,d){if(b.uuid){var f=
{};Object.keys(N).forEach(function(d){f[d]={};f[d]=N[d][b.uuid]});d({data:f})}else p.warn("bg: unable to process request",e,b),d({data:null})}},setTab:{allow:{script:!0},exec:function(b,e,d){if(e.tab&&b.uuid){N[e.tab.id]||(N[e.tab.id]={});var f={};b.tab&&Object.keys(b.tab).forEach(function(d){f[d]=b.tab[d]});N[e.tab.id][b.uuid]=f}else p.warn("bg: unable to process request",e,b);d({})}},focusTab:{allow:{script:!0},exec:function(b,e,d){(b=e&&e.tab?e.tab.id:null)?rea.tabs.update(b,{active:!0},function(){d({error:rea.runtime.lastError})}):
d({error:"internal error"})}},closeTab:{allow:{script:!0},exec:function(b,e,d){var f=e&&e.tab?e.tab.id:null;f?rea.tabs.query({windowType:"normal"},function(b){1>=b.length?(p.warn("bg:","refused to close last tab!"),d({error:"refused to close last tab!"})):rea.tabs.remove(f,function(){d({})})}):d({error:"internal error"})}},copyToClipboard:{allow:{script:!0,extpage:!0},exec:function(b,e,d){e.tab?oa.copy(b.data):p.warn("bg: unable to process request",e,b);d({})}},setOption:{allow:{extpage:!0},exec:function(b,
e,d){e="options"==e.extpage||"options"==b.origin;g.values[b.name]=b.value;e?U.create("options.settings").done(function(b){d({items:b,options:g.snapshot})}).fail(function(b){d({error:b,options:g.snapshot})}):d({})}},reportAnIssue:{allow:{extpage:!0},exec:function(b,e,d){var f,h,c;b.uuid&&(f=y.getByUid(b.uuid))&&f.script&&f.cond&&(e=w.determineOrigin(f.script),"author"==b.to&&f.script.supportURL?(h={url:f.script.supportURL},c=e?[b.to,e.token,e.id].join(":"):[b.to,h.url].join(":")):e&&(h=e,c=[h.token,
h.id].join(":")),h&&(L.tS(f.script.name,c,"m"),rea.tabs.create({url:h.issue_url||h.url,active:!0},function(){})));d({})}},begEvent:{allow:{extpage:!0},exec:function(b,e,d){if("dialog"==b.action)Z.dialog.shown(b.extra);else if("clicked"==b.action){var f,h;b.extra&&(f=b.extra.amount,h=b.extra.currency);Z.clicked(b.type,f,h)}else if(Z.button[b.action])Z.button[b.action](b.extra);else p.warn("bg: Warning: unknown request ",b);d({})}},buttonPress:{allow:{extpage:!0},exec:function(b,e,d){var f=function(){d({})};
if("reset_simple"==b.name)T.reset(f);else if("reset_factory"==b.name)T.factoryReset(f);else if("create_tesla_data"==b.name)H.createTeslaData().done(function(c){oa.copy({content:K.UTF8.encode(c.join("<br>")),type:"html"});f()});else if("reset_chrome_sync"==b.name)H.reset().always(f);else if("install_tests"==b.name)(e=ea.framework.prepare(w.doSave,q.RUNTIME.BROWSER,q.RUNTIME.BROWSER_VERSION,f))&&p.error(e);else if("enabled"==b.name)g.values[b.name]=!g.values[b.name],d({});else if("installFromUrl"==
b.name)w.installFromUrl(b.data).always(function(){d({})});else if("externals_delete"==b.name)O.cleanElement(b.scriptuid,b.safe_url),U.create("options.scripts").done(function(c){d({items:c,options:g.snapshot})}).fail(function(c){d({error:c,options:g.snapshot})});else if("focus_tab"==b.name)aa.focusTab.exec({},{tab:{id:b.tabid}},d);else if("run_script_updates"==b.name)if(b.scriptuid){var h;X.check(!0,!1,b.scriptuid).done(function(c){h=c}).always(function(){d({scriptuid:b.scriptuid,updatable:h})})}else X.check(!0,
!0),d({});else p.warn("bg: Warning: unknown button "+b.name),d({})}},loadTree:{allow:{extpage:!0},exec:function(b,e,d){U.create(b.referrer,{complete:b.complete,uuid:b.uuid}).done(function(b){d({items:b,i18n:g.values.i18n,options:g.snapshot,begging:Z.needed()})}).fail(function(b){d({error:b,options:g.snapshot})})}},modifyScriptOptions:{allow:{extpage:!0},exec:function(b,e,d){if(b.uuid){var f="options"==e.extpage||"options"==b.origin,h=void 0==b.reload||1==b.reload,c=y.getByUid(b.uuid);if(c.script&&
c.cond){var a=!1,m=new x.Script;Object.keys(m.options).forEach(function(a){void 0!==b[a]&&(c.script.options[a]=b[a])});Object.keys(m.options.override).forEach(function(d){-1!=d.search("merge_")&&void 0!==b[d]&&(c.script.options.override[d]=b[d],a=!0)});["includes","excludes","matches"].forEach(function(d){void 0!==b[d]&&(a=!0,c.script.options.override["use_"+d]=b[d])});["connects","blockers"].forEach(function(a){void 0!==b[a]&&(c.script.options.override["use_"+a]=b[a])});a&&(c.script=w.mergeCludes(c.script));
b.temp_connects&&da.setSessionConnects(c.script.uuid,b.temp_connects);void 0!==b.enabled&&(c.script.enabled=b.enabled);w.doModify(c.script.uuid,c.script,!1).done(function(){h?(void 0!==b.position&&w.reorderScripts(b.uuid,b.position),f?aa.loadTree.exec({referrer:"options.scripts"},e,d):rea.tabs.getSelected(null,function(a){U.create("actions").done(function(a){d({items:a,i18n:g.values.i18n,options:{enabled:g.values.enabled,layout:g.values.layout}})}).fail(function(){d({i18n:g.values.i18n,options:{enabled:g.values.enabled,
layout:g.values.layout}})});b.uuid&&g.values.autoReload&&rea.tabs.sendMessage(a.id,{method:"reload",frameId:0},function(){})})):d({})}).fail(function(){d({})});return!0}}d({})}},modifyNativeScript:{allow:{extpage:!0},exec:function(b,n,d){if(b.nid){var f=void 0==b.reload||1==b.reload;M.getUserscriptById(b.nid).then(function(d){if(d)if("installed"==b.actionid){if("false"==b.value)return M.uninstall(d)}else{if("enabled"==b.actionid)return M.setEnabled(d,b.value);if("imported"==b.actionid&&"true"==b.value){var c=
M.getUserscriptSource(d);if(c)return w.doSave({src:c,ask:!0,replace:!0}).then(function(a){if(a.installed){if("disable"==g.values.native_import_post_action)return M.setEnabled(d,!1);if("uninstall"==g.values.native_import_post_action)return M.uninstall(d)}});rea.tabs.sendMessage(n.tab.id,{method:"showMsg",msg:e.getMessage("Please_double_check_the_native_script_import_settings__")},function(){})}}else f=!1;return l.Pledge()}).always(function(){f?aa.loadTree.exec({referrer:"options.scripts"},n,d):d({})});
return!0}d({})}},saveScript:{allow:{extpage:!0},exec:function(b,n,d){var f=void 0===b.reload||!!b.reload,h=function(a){f?U.create("options.scripts").done(function(c){a.items=c;a.options=g.snapshot;d(a)}).fail(function(a){d({error:a,options:g.snapshot})}):d({})};if(b.clean){p.debug("bg: clean userscript "+b.uuid);n=y.getByUid(b.uuid);var c=function(a){U.create("options.scripts").done(function(c){d({cleaned:a.installed,items:c,options:g.snapshot});a.installed&&y.notifyStorageListeners({uuid:b.uuid},
null,function(a){a({storage:y.getStorageByUid(b.uuid)})})}).fail(function(a){d({error:a,options:g.snapshot})})};n.script&&n.cond?w.doSave({name:b.name,uuid:b.uuid,src:n.script.textContent,clean:!0,ask:!1,internal:!0,save:!0}).always(function(a){c(a||{installed:!1})}):(p.error(e.getMessage("fatal_error")+" ("+b.uuid+")!!!"),c({installed:!1}))}else if(b.code){var a=d;f&&(a=function(a){w.reorderScripts();h(a)});b.new_script&&(b.uuid=u.createUUID());w.doSave({name:b.name,uuid:b.uuid,force_url:b.force_url,
src:b.code,ask:!g.values.editor_easySave,lastModified:b.lastModified,save:!0}).always(function(c){a(c||{installed:!1})})}else b.auto_save||(w.doRemove(b.uuid),w.reorderScripts()),h({})}},exportToJson:{allow:{extpage:!0},exec:function(b,e,d){w.exportToJson(b.ids,b.options).done(function(b){d({json:b})}).fail(function(){d({})})}},importFromJson:{allow:{extpage:!0},exec:function(b,n,d){var f=void 0===b.reload||!!b.reload;w.importFromJson(b.json).fail(function(b){d({error:b||e.getMessage("An_error_occured_during_import_")})}).done(function(b){var c=
{reload:b.global_settings};f&&!c.reload?U.create("options.scripts").done(function(a){c.items=a;c.options=g.snapshot;d(c)}).fail(function(a){d({error:a,options:g.snapshot})}):d(c)})}},askCom:{allow:{extpage:!0},exec:function(b,e,d){ba.onMessage(b.data).always(function(b){b.i18n=g.values.i18n;b.options={statistics_enabled:g.values.statistics_enabled};b.ext={version:rea.extension.manifest.version};d(b)})}},installScript:{allow:{insecure:!0},exec:function(b,n,d){if(n.tab){var f={};w.installFromUrl(b.url,
{},{silent_fail:!0}).done(function(b){f={data:null,found:!0,installed:b}}).fail(function(b){f.err=b&&b.messages&&b.messages.errors?b.messages.errors[0]:e.getMessage("Unable_to_parse_this_")}).always(function(){d(f)})}else p.warn("bg: Error: unable to install script due to empty tabID!")}},execMenuCmd:{allow:{extpage:!0},exec:function(b,e,d){(b=Y.getById(b.id))?b.response({run:!0,menuId:b.id}):p.warn("bg: Error: unable to find MC id "+b.id);d({})}},unLoad:{allow:{script:!0},exec:function(b,e){b.topframe||
b.id&&B.events.unload(e.tab.id,e.tab.frameId,b.id)}},prepare:{allow:{script:!0},exec:function(b,e,d){if(e.tab){var f=b.topframe?0:null,h=A.woHash(b.url);B.events.run(e.tab.id,f,b.id,h,function(c){c=u.select(c,function(a){return a});var a=[{m:"native",t:[G.staticVars.DEFAULT,G.staticVars.NATIVE]},{m:"disabled",t:[G.staticVars.OFF]},{m:"browser",t:[G.staticVars.CHROME]}].filter(function(a){if(-1!=a.t.indexOf(g.values.downloads_mode))return!0}).map(function(a){return a.m})[0]||"disabled",a={scripts:c,
contexters:ia.getContexterCount(),raw:{},inIncognitoContext:rea.extension.inIncognitoContext,downloadMode:a,enforce_strict_mode:"on"==g.values.runtime_strict_mode,use_strong_mode:"on"==g.values.runtime_strong_mode,logLevel:g.values.logLevel,version:rea.extension.manifest.version};if(b.raw&&c.length)for(c=0;c<b.raw.length;c++)a.raw[b.raw[c]]=Registry.getRaw(b.raw[c]);d(a);R.setIcon(e.tab.id);R.setBadge(e.tab.id)});return!0}d({});return!1}},notification:{allow:{script:!0,extpage:!0},exec:function(b,
e,d){var f=b.image?b.image:rea.extension.getURL("images/icon128.png");(function(){var d=l();b.highlight&&e.tab?P.highlight(e.tab.id,d.resolve):d.resolve();return d.promise()})().then(function(){var d=l();b.text?P.show(b.title,b.text,f,b.timeout,d.resolve):d.resolve();return d.promise()}).always(function(b){d({clicked:b&&b.clicked})})}},syntaxCheck:{allow:{script:!0,extpage:!0},exec:function(b,e,d){(function(){var b=l();Registry.require("hinter",function(){b.resolve(Registry.get("hinter"))});return b.promise()})().then(function(d){return d.hint(b.code,
{maxerr:999},{})}).always(function(b){d({errors:b})})}},handler:function(b,e,d){if(!E.late)return E.registerLateCallback(function(){aa.handler(b,e,d)}),!0;var f=aa[b.method];if(f)if(f.allow&&f.exec){var h=rea.runtime.id,h=!q.REQUESTS.HAS_SENDER_ID&&e.tab||e.id===h,c=null,a=q.REQUESTS.INTERNAL_PAGE_PROTOCOL+"//",g=q.REQUESTS.GET_INTERNAL_PAGE_REGEXP(),k=e.url?e.url:e.tab?e.tab.url:null;if(a=h&&(k?0==k.search(a):!0))k?(g=k.match(g))&&2==g.length&&(c=g[1]):c="*",e.extpage=c;g="options"==c;if("background"==
c||f.allow.insecure||f.allow.extpage&&a||f.allow.options&&g||f.allow.script&&h&&!a){if(f=f.exec(b,e,d),void 0!==f)return f}else return!1===b.topframe&&(a||g)||p.warn("back: this context doesn't have the permission to call \""+b.method+'"'),!1}else return p.warn("b: invalid implementation of "+b.method),!1;else return p.warn("back: unknown method "+b.method),!1;return!0}},xa=function(){var b=[{name:e.getMessage("Default"),value:"default"}],g=!1,d={default:e.getMessage("Default"),solarized:"Solarized",
monokai:"Monokai",mdnlike:"MDN-like",eclipse:"Eclipse",railscasts:"RailsCasts"};return{getLayouts:function(){if(!g){var d=qa.getLayouts().map(function(b){return{name:b.charAt(0).toUpperCase()+b.slice(1),value:b}});b=b.concat(d);g=!0}return b},getEditorThemes:function(){return qa.editorThemes.map(function(b){return{name:d[b]||b,value:b}})}}}(),Y=function(){var b=[];return{add:function(e,d,f,h,c){b.push({tabId:e,name:d,accessKey:f,id:h,response:c})},list:function(){return b},listByTabId:function(e){var d=
{};return b.filter(function(b){return b.tabId==e&&!d[b.name]&&(d[b.name]=!0)})},clearByTabId:function(e){b=b.filter(function(b){return b.tabId!=e})},getByTabId:function(e){return b.filter(function(b){return b.tabId==e})[0]},clearById:function(e){b=b.filter(function(b){return b.id!=e})},getById:function(e){return b.filter(function(b){return b.id==e})[0]}}}(),Fa=function(){return{create:function(){var b,n,d,f,h,c,a,m,k,l,p,r,v,t;l=null;b={name:e.getMessage("General"),sub_menu_item:!0,items:[]};b.items.push({name:e.getMessage("Config_Mode"),
id:"configMode",level:0,option:!0,select:[{name:e.getMessage("Novice"),value:0},{name:e.getMessage("Beginner"),value:50},{name:e.getMessage("Advanced"),value:100}],value:g.values.configMode,desc:e.getMessage("Changes_the_number_of_visible_config_options")});b.items.push({name:e.getMessage("Language"),id:"i18n",level:0,option:!0,reload:!0,warning:e.getMessage("A_reload_is_required"),select:[{name:"Browser Default",value:null}].concat(e.supported),value:g.values.i18n,validation:{image:"info",opacity:.9,
msg:e.getMessage("Your_language_is_not_supported__Click_here_to_get_intructions_how_to_translate_TM_"),url:"http://tampermonkey.net/faq.php#Q500"}});b.items.push({name:e.getMessage("Auto_reload_on_script_enabled"),level:20,id:"autoReload",option:!0,checkbox:!0,enabled:g.values.autoReload,desc:e.getMessage("Auto_reload_on_script_enabled_desc")});b.items.push({name:e.getMessage("Anonymous_statistics"),level:0,id:"statistics_enabled",option:!0,checkbox:!0,enabled:g.values.statistics_enabled,validation:{image:"info",
opacity:.9,msg:e.getMessage("Allow_Tampermonkey_to_collect_anonymous_statistics_via_Google_Analytics"),url:"http://tampermonkey.net/privacy.php#extension"}});b.items.push({name:e.getMessage("Debug_scripts"),level:100,id:"debug",option:!0,checkbox:!0,enabled:g.values.debug,desc:""});b.items.push({name:e.getMessage("Show_fixed_source"),level:100,id:"showFixedSrc",option:!0,checkbox:!0,enabled:g.values.showFixedSrc,desc:""});b.items.push({name:e.getMessage("LogLevel"),id:"logLevel",level:0,option:!0,
select:[{name:e.getMessage("Debug"),value:60},{name:e.getMessage("Warning"),value:30},{name:e.getMessage("Error"),value:0}],value:g.values.logLevel,desc:""});q.OPTIONS.NATIVE_SCRIPT_IMPORT&&(n={name:e.getMessage("Native_Script_Import"),sub_menu_item:!0,need_save:!0,items:[]},l={},g.values.native_import&&(l=!0===q.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS?{image:"button_ok",msg:e.getMessage("TM_has_access_to_file_URIs")}:{image:"critical",msg:e.getMessage("Tampermonkey_needs_access_to_file_URIs__Visit_the_FAQ_"),
url:"http://tampermonkey.net/faq.php#Q204"}),n.items.push({name:e.getMessage("Enable_Native_Script_Import"),id:"native_import",level:0,option:!0,checkbox:!0,enabled:g.values.native_import,validation:l}),n.items.push({name:e.getMessage("Post_Import_Action"),id:"native_import_post_action",level:0,option:!0,select:[{name:e.getMessage("None"),value:"none"},{name:e.getMessage("Disable_Extension"),value:"disable"},{name:e.getMessage("Uninstall_Extension"),value:"uninstall"}],value:g.values.native_import_post_action,
desc:e.getMessage("What_action_should_be_done_after_a_native_userscript_was_imported_sucessfully_")}),l={},g.values.native_import&&(l=M.isPathValid()?{image:"button_ok",msg:e.getMessage("Everything_is_setup_correctly_")}:{image:"critical",msg:e.getMessage("Tampermonkey_needs_to_know_the_absolute_path_to_your_browser_profile_folder_Visit_the_FAQ_"),url:"http://tampermonkey.net/faq.php#Q205"}),n.items.push({name:e.getMessage("Browser_Profile_Path"),id:"native_import_path",level:0,option:!0,text:!0,
width:2,value:g.values.native_import_path,validation:l}));q.OPTIONS.HAS_TESLA&&(r={name:e.getMessage("TESLA"),sub_menu_item:!0,level:50,need_save:!0,items:[]},r.items.push({name:e.getMessage("Enable_TESLA"),id:"sync_enabled",level:50,option:!0,checkbox:!0,enabled:g.values.sync_enabled,desc:e.getMessage("Tampermonkey_External_Script_List_Access")}),d=[{name:"pastebin.com",value:I.types.ePASTEBIN,enable:{sync_id:!0,sync_version:!1,create_tesla_data:!0}},{name:"Chrome Sync",value:I.types.eCHROMESYNC,
enable:{sync_id:!1,sync_version:!0,create_tesla_data:!1}}],q.SYNC.GOOGLE_DRIVE.SUPPORTED&&d.push({name:"Google Drive (Beta)",value:I.types.eGOOGLEDRIVE,enable:{sync_id:!1,sync_version:!1,create_tesla_data:!1}}),r.items.push({name:e.getMessage("Sync_Type"),id:"sync_type",enabler:!0,level:50,option:!0,select:d,value:g.values.sync_type}),r.items.push({name:e.getMessage("Sync_Id"),id:"sync_id",enabledBy:"sync_type",level:50,text:!0,value:g.values.sync_id,option:!0}),r.items.push({name:e.getMessage("Sync_Version"),
id:"sync_version",enabledBy:"sync_type",level:50,option:!0,select:[{name:"v1 - Legacy",value:1},{name:"v2 - Beta",value:2,warning:e.getMessage("This_sync_version_may_multiply_each_script_that_is_present_at_more_than_one_Tampermonkey_instance__Do_you_really_want_to_continue_")}],value:g.values.sync_version,desc:e.getMessage("Different_sync_versions_are_not_compatible_to_each_other_")}),r.items.push({name:e.getMessage("Create_Exportable_Data"),id:"create_tesla_data",enabledBy:"sync_type",button:!0,
ignore:!0,level:60,warning:e.getMessage("Copy_exportable_data_to_clipboard_Ok_")}));c={name:e.getMessage("Appearance"),sub_menu_item:!0,items:[]};c.items.push({name:e.getMessage("Layout"),id:"layout",level:0,option:!0,select:xa.getLayouts(),value:g.values.layout,desc:""});l={};"off"==g.values.notification_showUpdate&&(l={image:"critical",msg:e.getMessage("Are_you_sure_that_you_don_t_want_to_be_notified_of_updates_")});c.items.push({name:e.getMessage("Update_Notification"),id:"notification_showUpdate",
level:50,option:!0,select:[{name:e.getMessage("Disabled"),value:"off"},{name:e.getMessage("Show_notification"),value:"notification"},{name:e.getMessage("Open_changelog"),value:"changelog"}],value:g.values.notification_showUpdate,validation:l});a={name:e.getMessage("Action_Menu"),sub_menu_item:!0,items:[],level:50};a.items.push({name:e.getMessage("Hide_disabled_scripts"),id:"action_menu_scripts_hide_disabled",level:100,option:!0,checkbox:!0,enabled:g.values.action_menu_scripts_hide_disabled,desc:""});
a.items.push({name:e.getMessage("Columns"),id:"action_menu_columns",level:50,option:!0,select:[{name:e.getMessage("1"),value:"1"},{name:e.getMessage("2"),value:"2"},{name:e.getMessage("3"),value:"3"}].filter(function(a){return a.value<=q.ACTIONMENU.COLUMNS}),value:g.values.action_menu_columns});a.items.push({name:e.getMessage("Script_order"),id:"action_menu_scripts_sort",level:50,option:!0,select:[{name:e.getMessage("Position_"),value:"position"},{name:e.getMessage("Name"),value:"name"},{name:e.getMessage("Enabled"),
value:"enabled"}],value:g.values.action_menu_scripts_sort});a.items.push({name:e.getMessage("Icon_badge_info"),id:"appearance_badges",level:50,option:!0,select:[{name:e.getMessage("Disabled"),value:"off"},{name:e.getMessage("Running_scripts"),value:"running"},{name:e.getMessage("Unique_running_scripts"),value:"running_unique"},{name:e.getMessage("Disabled_scripts"),value:"disabled"}],value:g.values.appearance_badges});(q.RUNTIME.CHROME||q.RUNTIME.FIREFOX)&&a.items.push({name:e.getMessage("Icon_badge_color"),
id:"appearance_badge_color",level:100,color:!0,value:g.values.appearance_badge_color});d={name:e.getMessage("Editor"),sub_menu_item:!0,level:20,need_save:!0,items:[],warning:e.getMessage("A_reload_is_required"),reload:!0};d.items.push({name:e.getMessage("Enable_Editor"),id:"editor_enabled",level:100,option:!0,checkbox:!0,enabled:g.values.editor_enabled,desc:""});d.items.push({name:e.getMessage("Theme"),id:"editor_theme",level:50,option:!0,select:xa.getEditorThemes(),value:g.values.editor_theme});
d.items.push({name:e.getMessage("Font_Size"),id:"editor_fontSize",level:50,option:!0,select:[{name:"50%",value:50},{name:"70%",value:70},{name:"80%",value:80},{name:"90%",value:90},{name:"100%",value:100},{name:"110%",value:110},{name:"120%",value:120},{name:"150%",value:150}],value:g.values.editor_fontSize});d.items.push({name:e.getMessage("Key_Mapping"),id:"editor_keyMap",level:50,option:!0,select:[{name:e.getMessage("Windows"),value:"windows"},{name:e.getMessage("Sublime"),value:"sublime"},{name:e.getMessage("Emacs"),
value:"emacs"},{name:e.getMessage("Vim"),value:"vim"}],value:g.values.editor_keyMap});d.items.push({name:e.getMessage("Indentation_Width"),id:"editor_indentUnit",level:50,option:!0,select:[{name:e.getMessage("1"),value:1},{name:e.getMessage("2"),value:2},{name:e.getMessage("3"),value:3},{name:e.getMessage("4"),value:4},{name:e.getMessage("5"),value:5},{name:e.getMessage("6"),value:6},{name:e.getMessage("7"),value:7},{name:e.getMessage("8"),value:8},{name:e.getMessage("9"),value:9},{name:e.getMessage("10"),
value:10},{name:e.getMessage("11"),value:11}],value:g.values.editor_indentUnit,desc:""});d.items.push({name:e.getMessage("Indent_with"),id:"editor_indentWithTabs",level:50,option:!0,select:[{name:e.getMessage("Tabs"),value:"tabs"},{name:e.getMessage("Spaces"),value:"spaces"}],value:g.values.editor_indentWithTabs,desc:""});d.items.push({name:e.getMessage("TabMode"),id:"editor_tabMode",level:50,option:!0,select:[{name:e.getMessage("Classic"),value:"classic"},{name:e.getMessage("Smart"),value:"smart"},
{name:e.getMessage("Indent"),value:"indent"}],value:g.values.editor_tabMode,desc:""});d.items.push({name:e.getMessage("Reindent_on_typing"),id:"editor_electricChars",level:50,option:!0,checkbox:!0,enabled:g.values.editor_electricChars,desc:""});d.items.push({name:e.getMessage("Enable_autoSave"),id:"editor_autoSave",level:20,option:!0,checkbox:!0,enabled:g.values.editor_autoSave,desc:""});d.items.push({name:e.getMessage("Enable_easySave"),id:"editor_easySave",level:20,option:!0,checkbox:!0,enabled:g.values.editor_easySave,
desc:""});d.items.push({name:e.getMessage("Highlight_trailing_whitespace"),id:"editor_highlightTrailingWhitespace",level:50,option:!0,checkbox:!0,enabled:g.values.editor_highlightTrailingWhitespace,desc:""});d.items.push({name:e.getMessage("Auto_syntax_check_on_typing"),id:"editor_autoLint",level:50,option:!0,checkbox:!0,enabled:g.values.editor_autoLint,desc:e.getMessage("Enable_this_option_to_automatically_check_the_code_on_typing_")});d.items.push({name:e.getMessage("Auto_syntax_check_max_length"),
id:"editor_autoLintMaxLen",level:50,option:!0,text:!0,value:g.values.editor_autoLintMaxLen,desc:e.getMessage("Check_only_scripts_up_to_this_size_automatically_")});h={name:e.getMessage("Script_Update"),sub_menu_item:!0,level:0,items:[]};h.items.push({name:e.getMessage("Check_disabled_scripts"),id:"scriptUpdateCheckDisabled",level:0,option:!0,checkbox:!0,enabled:g.values.scriptUpdateCheckDisabled,desc:""});h.items.push({name:e.getMessage("Dont_ask_me_for_simple_script_updates"),id:"notification_silentScriptUpdate",
level:80,option:!0,checkbox:!0,enabled:g.values.notification_silentScriptUpdate,desc:""});h.items.push({name:e.getMessage("Check_interval"),id:"scriptUpdateCheckPeriod",level:0,option:!0,select:[{name:e.getMessage("Never"),value:0},{name:e.getMessage("Every_6_Hours"),value:216E5},{name:e.getMessage("Every_12_Hour"),value:432E5},{name:e.getMessage("Every_Day"),value:864E5},{name:e.getMessage("Every_Week"),value:6048E5}],value:g.values.scriptUpdateCheckPeriod,desc:""});h.items.push({name:e.getMessage("Hide_notification_after"),
id:"scriptUpdateHideNotificationAfter",level:50,option:!0,select:[{name:e.getMessage("Never"),value:0},{name:e.getMessage("15_Seconds"),value:15E3},{name:e.getMessage("30_Seconds"),value:3E4},{name:e.getMessage("1_Minute"),value:6E4},{name:e.getMessage("5_Minutes"),value:3E5},{name:e.getMessage("1_Hour"),value:36E5}],value:g.values.scriptUpdateHideNotificationAfter,desc:""});f={name:e.getMessage("Externals"),sub_menu_item:!0,level:0,items:[]};f.items.push({name:e.getMessage("Update_interval"),id:"external_update_interval",
level:0,option:!0,select:[{name:e.getMessage("Always"),value:1},{name:e.getMessage("Every_Day"),value:864E5},{name:e.getMessage("Every_Week"),value:6048E5},{name:e.getMessage("Every_Month"),value:2592E6},{name:e.getMessage("Never"),value:0}],value:g.values.external_update_interval,desc:""});m={name:e.getMessage("Security"),sub_menu_item:!0,level:50,items:[]};q.OPTIONS.HAS_CSP&&(m.items.push({name:e.getMessage("Add_TM_to_CSP"),id:"webrequest_fixCSP",level:80,option:!0,select:[{name:e.getMessage("Yes"),
value:"yes"},{name:e.getMessage("No"),value:"no"}],value:g.values.webrequest_fixCSP,desc:e.getMessage("Tampermonkey_might_not_be_able_to_provide_access_to_the_unsafe_context_when_this_is_disabled")}),m.items.push({name:e.getMessage("Allow_headers_to_be_modified_by_scripts"),id:"webrequest_modHeaders",level:80,option:!0,reload:!0,select:[{name:e.getMessage("Yes"),value:"yes"},{name:e.getMessage("Auto"),value:"auto"},{name:e.getMessage("No"),value:"no"}],value:g.values.webrequest_modHeaders,warning:e.getMessage("Tampermonkey_needs_to_be_restarted_to_make_this_change_apply_Do_you_want_to_continue_"),
desc:""}));m.items.push({name:e.getMessage("Subresource_Integrity"),id:"require_sri_mode",level:80,option:!0,select:[{name:e.getMessage("Disabled"),value:"ignore"},{name:e.getMessage("Validate_if_supported"),value:"supported"},{name:e.getMessage("Validate_if_given"),value:"given"},{name:e.getMessage("Enforce"),value:"enforce"}],value:g.values.require_sri_mode,desc:e.getMessage("Script_authors_can_secure_external_resources_by_adding_a_SRI_hash_to_the_URL_")});m.items.push({name:e.getMessage("connect_mode"),
id:"connect_mode",level:50,option:!0,select:(80<=g.values.configMode||-1!=["off","casual"].indexOf(g.values.connect_mode)?[{name:e.getMessage("Disabled"),value:"off"},{name:e.getMessage("Casual"),value:"casual"}]:[]).concat([{name:e.getMessage("Ask_if_unknown"),value:"ask"},{name:e.getMessage("Strict"),value:"strict"},{name:e.getMessage("Always_ask"),value:"paranoid"}]),value:g.values.connect_mode,desc:""});q.RUNTIME.INCOGNITO_MODE&&!rea.extension.inIncognitoContext&&(l="temporary"==g.values.incognito_mode?
{}:{image:"critical",msg:"Permanent mode is still a BETA feature!"},m.items.push({name:e.getMessage("Store_data_in_incognito_mode"),id:"incognito_mode",level:50,option:!0,select:[{name:e.getMessage("Temporary"),value:"temporary"},{name:e.getMessage("Permanent"),value:"permanent"}],value:g.values.incognito_mode,validation:l}));m.items.push({name:e.getMessage("Page_Filter_Mode"),id:"page_filter_mode",level:50,option:!0,select:[{name:e.getMessage("Disabled"),value:"off"},{name:e.getMessage("Blacklist"),
value:"black"},{name:e.getMessage("Whitelist"),value:"white"},{name:e.getMessage("Both"),value:"black+white"}],value:g.values.page_filter_mode,desc:""});m.items.push({name:e.getMessage("Whitelisted_Pages"),id:"page_whitelist",level:50,option:!0,input:!0,array:!0,value:g.values.page_whitelist,desc:""});m.items.push({name:e.getMessage("Blacklisted_Pages"),id:"forbiddenPages",level:50,option:!0,input:!0,array:!0,value:g.values.forbiddenPages,desc:""});k={name:e.getMessage("BlackCheck"),sub_menu_item:!0,
level:50,items:[]};k.items.push({name:e.getMessage("Script_Blacklist_Source"),id:"script_blacklist_type",level:50,option:!0,select:[{name:e.getMessage("Disabled"),value:"off"},{name:e.getMessage("Server_And_Manual"),value:"server"},{name:e.getMessage("Only_Manual"),value:"only_manual"}],value:g.values.script_blacklist_type});k.items.push({name:e.getMessage("Blacklist_Severity"),id:"script_blacklist_severity",level:50,option:!0,select:[{name:e.getMessage("severity_1"),value:1},{name:e.getMessage("severity_2"),
value:2},{name:e.getMessage("severity_3"),value:3},{name:e.getMessage("severity_4"),value:4},{name:e.getMessage("severity_5"),value:5},{name:e.getMessage("severity_6"),value:6},{name:e.getMessage("severity_7"),value:7},{name:e.getMessage("severity_8"),value:8},{name:e.getMessage("severity_9"),value:9},{name:e.getMessage("severity_10"),value:10}],value:g.values.script_blacklist_severity});k.items.push({name:e.getMessage("Manual_Script_Blacklist"),id:"require_blacklist",level:50,option:!0,input:!0,
array:!0,value:g.values.require_blacklist,desc:""});if(q.OPTIONS.CAN_DOWNLOAD){var z=!1;l={};u.map("exe sh crx com bat scr".split(" "),function(a){return"name."+a}).forEach(function(a){z|=G.is_whitelisted(a)});z&&(l={image:"critical",msg:e.getMessage("Your_whitelist_seems_to_include_executable_files_This_means_your_userscripts_may_download_malware_or_spyware_to_your_harddisk_")});t={name:e.getMessage("Downloads")+" BETA",sub_menu_item:!0,level:50,items:[]};t.items.push({name:e.getMessage("Download_Mode"),
id:"downloads_mode",level:50,option:!0,select:u.select([{name:e.getMessage("Default"),value:G.staticVars.DEFAULT},{name:e.getMessage("Disabled"),value:G.staticVars.OFF},{name:e.getMessage("Native"),value:G.staticVars.NATIVE},{name:e.getMessage("Browser_API"),value:q.DOWNLOAD.SUPPORTED?G.staticVars.CHROME:null}],function(a){return a.value}),value:g.values.downloads_mode,desc:e.getMessage("The_Browser_API_mode_requires_a_special_permission_")+'\n"Default" is "Native".'});t.items.push({name:e.getMessage("Whitelisted_File_Extensions"),
id:"downloads_extension_whitelist",level:50,option:!0,input:!0,array:!0,value:g.values.downloads_extension_whitelist,desc:e.getMessage("Only_files_with_these_extensions_can_be_saved_to_the_harddisk_Be_careful_to_not_allow_file_extensions_that_represent_executables_at_your_operating_system_"),validation:l})}p={name:e.getMessage("Experimental"),sub_menu_item:!0,level:80,items:[]};p.items.push({name:e.getMessage("strict_mode"),id:"runtime_strict_mode",level:80,option:!0,select:[{name:e.getMessage("Default"),
value:"byscript"},{name:e.getMessage("Always"),value:"on"},{name:e.getMessage("Disabled"),value:"off"}],value:g.values.runtime_strict_mode});p.items.push({name:e.getMessage("strong_mode"),id:"runtime_strong_mode",level:80,option:!0,select:[{name:e.getMessage("Default"),value:"off"},{name:e.getMessage("Enabled"),value:"on"}],value:g.values.runtime_strong_mode});l={name:e.getMessage("Userscripts"),sub_menu_item:!0,level:80,items:[]};l.items.push({name:e.getMessage("Script_URL_detection"),id:"scriptUrlDetection",
level:80,option:!0,select:[{name:e.getMessage("Auto"),value:"auto"},{name:e.getMessage("Disabled"),value:"manual"}],value:g.values.scriptUrlDetection});l.items.push({name:e.getMessage("New_script_template_"),id:"script_templates",level:80,option:!0,input:!0,array:!0,named:!0,value:g.values.script_templates});v={name:e.getMessage("Reset_Section"),sub_menu_item:!0,level:50,items:[]};v.items.push({name:e.getMessage("Restart_Tampermonkey"),id:"reset_simple",level:50,button:!0,reload:!0,value:0,warning:e.getMessage("This_will_restart_Tampermonkey_Ok_")});
v.items.push({name:e.getMessage("Factory_Reset"),id:"reset_factory",level:80,button:!0,reload:!0,value:0,warning:e.getMessage("This_will_remove_all_scripts_and_reset_all_settings_Ok_")});q.OPTIONS.HAS_TESLA&&v.items.push({name:e.getMessage("Chrome_Sync_Reset"),id:"reset_chrome_sync",level:80,button:!0,reload:!0,value:0,warning:e.getMessage("This_will_remove_all_stored_data_from_google_sync_Ok_")});ea&&v.items.push({name:"Install Tests",id:"install_tests",level:80,button:!0,reload:!1,ignore:!0,value:0,
warning:"This will install a lot of test scripts!"});return[b,c,a,h,f,void 0,r,n,void 0,d,m,k,t,l,p,v].filter(function(a){return!!a})}}}(),U=function(){return{create:function(b,n){b=b||"";n=n||{};var d=function(b){return l.onebyone(b).fail(function(){p.warn("tree: wait failed!")}).then(function(a){return a.filter(function(a){return a})})},f=function(b,a){for(var d=b.replace(/\.$/,"").split("."),e=h;d.length;){var f=d.shift();if(e[f]){if("function"===typeof e[f])return function(){return e[f](n,!a)};
e=e[f];d.length||d.unshift("root")}else return p.warn("tree: unable to find",b,n),function(){return l.Pledge([])}}p.warn("tree: unable to find",b,n);return function(){return l.Pledge([])}},h={actions:{root:function(){var b=l();rea.tabs.getSelected(null,function(a){n.tab=a;a=d([f("actions.general"),f("actions.scripts"),f("actions.commands")]);b.consume(a)});return b.promise()},general:function(){var b=n.tab,a=b?b.url:null,d=a&&4<a.length&&""==a.substr(0,4).replace(/file|http/,"")?a:"",b=[],f={name:"enabled",
sub_menu_item:!0,pos:"top",items:[]};f.items.push({name:e.getMessage("Enabled"),display:g.values.enabled?null:"greyed",id:"enabled",button:!0,reload:!0,enabler:!0});b.push(f);"manual"==g.values.scriptUrlDetection&&ka.isScriptUrl(a)&&f.items.push({name:e.getMessage("Install_this_script"),image:"script_download",id:"installFromUrl",data:a,button:!0,reload:!0});a={name:"about",sub_menu_item:!0,pos:"bottom",items:[]};a.items.push({name:e.getMessage("Dashboard"),image:"utilities",url:rea.extension.getURL("options.html")+
"#"+["url="+K.Base64.encode(d),"nav=dashboard"].join("&"),newtab:!0});d="version="+rea.extension.manifest.version+"&ext="+rea.runtime.short_id;a.items.push({image:"info",urls:[{name:" "+e.getMessage("Help"),url:"http://tampermonkey.net/faq.php?"+d,newtab:!0},{name:" "+e.getMessage("Changelog"),url:"http://tampermonkey.net/changelog.php?"+d,newtab:!0}]});b.push(a);return l.Pledge(b)},scripts:function(){var b=n.tab,a=b?b.url:null,d=[],f=a&&4<a.length&&""==a.substr(0,4).replace(/file|http/,"")?a:"",
h,p={name:"scripts",sub_menu_item:!0,pos:"center",items:[]},b=w.getUniqueScriptsForTab(b),r=ja.getContexters(0,null),b=na([].concat(b).concat(r)),v;"position"!=g.values.action_menu_scripts_sort&&("name"==g.values.action_menu_scripts_sort?v=function(a,b){return a.name.toLowerCase()<b.name.toLowerCase()?-1:a.name.toLowerCase()>b.name.toLowerCase()?1:0}:"enabled"==g.values.action_menu_scripts_sort&&(v=function(a,b){return b.enabled-a.enabled}));g.values.action_menu_scripts_hide_disabled&&(b=b.filter(function(a){return a.enabled}));
v&&b.sort(v);!g.values.action_menu_scripts_hide_disabled&&2<Math.min(g.values.action_menu_columns,q.ACTIONMENU.COLUMNS)?(h={name:"scripts_right",sub_menu_item:!0,pos:"right",items:[]},b.forEach(function(a){(a.enabled?p:h).items.push(a)}),d.push(p),h.items.length&&d.push(h)):(h=p,p.items=p.items.concat(b),d.push(p));g.values.enabled&&!b.length&&a&&(ca.isAllowed(a)?p.items.push({name:e.getMessage("No_script_is_running"),image:"info"}):p.items.push({name:e.getMessage("This_page_is_blacklisted_at_the_security_settings"),
image:"critical"}));a=e.getLocale();g.values.enabled&&("3"==g.values.action_menu_columns||100>g.values.configMode||!b.length)&&(b.length?(v={name:"scripts_new",sub_menu_item:!0,pos:"center",items:[]},d.push(v)):v=p,v.items.push({name:e.getMessage("Get_new_scripts___"),image:"script_download",url:"http://tampermonkey.net/scripts.php"+(a?"?locale="+a:""),newtab:!0}),v.items.push({name:e.getMessage("Add_new_script___"),image:"script_add",url:rea.extension.getURL("options.html")+"#url="+K.Base64.encode(f)+
"&nav=new-user-script",newtab:!0}));return l.Pledge(d)},commands:function(){var b=n.tab,a=[],d=e.getLocale(),f={name:"commands",id:"commands",sub_menu_item:!0,pos:"left",items:[]},h=b.id,b=[],h=null==h||void 0==h?Y.list():Y.listByTabId(h),p;for(p in h)if(h.hasOwnProperty(p)){var r=h[p];b.push({name:r.name,id:r.id,accessKey:r.accessKey,image:"menu_cmd",menucmd:!0})}b.length&&(f.items=b);f.items.push({name:e.getMessage("Check_for_userscripts_updates"),id:"run_script_updates",button:!0,image:"update"});
80<=g.values.configMode&&f.items.push({name:e.getMessage("Report_a_bug"),image:"bug",url:"http://tampermonkey.net/bug",newtab:!0});f.items.push({name:e.getMessage("Please_consider_a_contribution"),image:"contrib",url:"http://tampermonkey.net/contrib.php"+(d?"?locale="+d:""),newtab:!0});a.push(f);return l.Pledge(a)}},options:{root:function(){return d([f("options.general"),f("options.verification"),f("options.scripts"),f("options.settings")])},general:function(){var b=[];b.push({name:"Version",id:null,
version:!0,value:rea.extension.manifest.version});rea.extension.inIncognitoContext&&"temporary"==g.values.incognito_mode&&b.push({globalhint:!0,image:"critical",value:e.getMessage("All_modifications_are_only_kept_until_this_incognito_session_is_closed_")});return l.Pledge(b)},verification:function(){var b=[];fa.getWarnings().forEach(function(a){b.push({globalhint:!0,image:"critical",value:a.text,description:a.description,info_url:a.url})});return l.Pledge(b)},scripts:{root:function(b,a){var h=l(),
g={name:e.getMessage("Installed_userscripts"),main_menu_item:!0,scriptTab:!0,id:"dashboard"};(function(){if(b.complete||!a)return d(u.map(["options.scripts.natives","options.scripts.userscripts","options.scripts.new"],function(a){return f(a)}));g.referrer="options.scripts";g.partial=!0;return d([f("options.scripts.new")])})().done(function(a){g.items=a;h.resolve([g])}).fail(h.reject);return h.promise()},"new":function(){var b=[];b.push({name:e.getMessage("New_userscript"),id:null,image:"script_add",
icon:rea.extension.getURL("images/txt.png"),nnew:!0,uuid:"new-user-script",position:-1,positionof:q.RUNTIME.MAX_SCRIPTS,enabled:!0,userscript:!0});return l.Pledge(b)},natives:function(){var b=[],a=l();M.getAllUserscripts().always(function(d){d=d||[];d.forEach(function(a){b.push({name:a.name,uuid:a.id,icon:a.icon,code:null,position:0,positionof:q.RUNTIME.MAX_SCRIPTS,enabled:a.enabled,version:a.version,description:a.description,nativeScript:!0})});a.resolve(b)});return a.promise()},userscripts:{root:function(b,
a){var d=b.complete||!a?null:"options.scripts.userscripts.source",d=na(w.determineScriptsToRun(null),!0,d),f=d.length,h=e.getLocale();d.push({name:e.getMessage("No_script_is_installed"),image:"info",visible:!f});d.push({name:e.getMessage("Get_some_scripts___"),image:"edit_add",url:"http://tampermonkey.net/scripts.php"+(h?"?locale="+h:""),newtab:!0,visible:!f});return l.Pledge(d)},source:function(b){if(!b.uuid)return l.Pledge([]);b=y.getByUid(b.uuid);if(b.script&&b.cond)return b=g.values.showFixedSrc?
ha.mkCompat(b.script.textContent,b.script,"off"!=g.values.runtime_strict_mode):b.script.textContent,l.Pledge([b]);p.warn("tree: unable to process ",b);return l.Breach()}}},settings:function(b,a){var d=l(),f={name:e.getMessage("Settings"),main_menu_item:!0,id:"settings",selected_default:!0},h;b.complete||!a?h=l.Pledge(Fa.create()):(f.referrer="options.settings",h=l.Pledge());h.done(function(a){f.items=a;d.resolve([f])}).fail(d.reject);return d.promise()}}};p.debug("tree: loading",b,n);return f(b,!0)()}}}(),
na=function(b,e,d){var f=[],h=new x.Script;["author","copyright"].forEach(function(b){h[b]=!1});Object.keys(b).forEach(function(c){var a=b[c],m;if(e){m={};var k=["textContent","requires","resources"];Object.keys(h).forEach(function(b){-1==k.indexOf(b)&&(u.toType(h[b]),m[b]=a[b])});d?(m.referrer=d,m.length=a.textContent.length):m.code=a.textContent;["requires","resources"].forEach(function(b){m[b]=u.map(a[b],function(b){var c=b.url||A.sanitize(b.unsafe_url,b.abs_url),d=O.getElement(a.uuid,c),e=0,f=
null,h=null;d&&d.data&&(d.data.content&&(e=d.data.content.length),h=d.data.sri,f=d.ts);return{display_url:b.url||b.unsafe_url,url:c,data:{length:e},sri:h,ts:f}})});m.origin=w.determineOrigin(a);m.contexter=w.isContexter(a);m.temp_connects=da.getSessionConnects(a.uuid)}else m={name:a.name,uuid:a.uuid,system:a.system,support:!!a.supportURL,origin:!!w.determineOrigin(a),contexter:w.isContexter(a),enabled:a.enabled,position:a.position};m.blacklisted=a.evilness>=g.values.script_blacklist_severity;a.evilness&&
(m.warnings=Q.getWarningsFor(w.determineSourceURL(a)));m.file_url=a.downloadURL||a.fileURL;m.positionof=b.length;m.userscript=!0;a.icon64||a.icon||(m.icon64=rea.extension.getURL("images/txt.png"));a.options&&Object.keys(h.options).forEach(function(b){m[b]=a.options[b]});f.push(m)});return f},oa={copy:function(b){var e=document.createElement("iframe"),d=document.body||document.documentElement||document;d.appendChild(e);try{e.contentDocument.designMode="on","html"==b.type?(e.setAttribute("sandbox",
"allow-same-origin"),e.contentDocument.documentElement.innerHTML=b.content,e.contentDocument.execCommand("selectAll",!1,null)):e.contentDocument.oncopy=function(d){d.clipboardData.setData(b.mimetype||"text/plain",b.content);d.preventDefault()},e.contentDocument.execCommand("copy",!1,null),e.contentDocument.designMode="off"}catch(f){p.warn("bg: clipboard Error: "+f.message)}d.removeChild(e);e=null}};clip=oa;var T={run:function(b,e){var d=1,f=function(){0==--d&&(e&&e(),rea.page.reload())};if("config"==
b){var h=t.listValues();Object.keys(h).forEach(function(b){b=h[b];-1==b.search(q.CONSTANTS.PREFIX.SCRIPT)&&-1==b.search(q.CONSTANTS.PREFIX.COND)&&-1==b.search(q.CONSTANTS.PREFIX.STORE)&&-1==b.search(q.CONSTANTS.PREFIX.META)&&(d++,t.deleteValue(b).always(f))})}else"factory"==b&&(d++,G.remove_permission().done(f),d++,t.factoryReset().always(f));f()},reset:function(b){T.run(null,b)},factoryReset:function(b){T.run("factory",b)},configReset:function(b){T.run("config",b)}},R=function(){var b=function(){rea.runtime.lastError&&
void 0},n={init:function(){n.setIcon();var b=g.values.appearance_badge_color||"#ee3131";"#"!==b[0]&&(b="#"+b);rea.browserAction.setBadgeBackgroundColor({color:b})},setIcon:function(d){var f,h;h=null;var c=f=!1;void 0===d||B.get.empty(d)||(f=B.get.blocker(d),c=B.get.forbidden(d));c?(f="_forbidden",h=e.getMessage("At_least_one_part_of_this_page_is_listed_at_the_forbidden_pages_setting_")):f?(f="_blocker",h=e.getMessage("Some_scripts_might_be_blocked_by_the_javascript_settings_for_this_page_or_a_script_blocker_")):
f=g.values.enabled&&void 0!==d?"":"_grey";p.debug("badge: set icon "+f);f={path:rea.extension.getURL("images/icon"+f+".png")};h={title:h?h:rea.extension.manifest.name};null!=d&&(f.tabId=d,h.tabId=d);try{rea.browserAction.setIcon(f,b),rea.browserAction.setTitle(h)}catch(a){p.warn("bg: ERROR while setIcon! "+a.message)}},setBadge:function(b){var e=0;"off"==g.values.appearance_badges?e=0:"running"==g.values.appearance_badges?b&&!B.get.empty(b)&&(e=B.get.stats(b).running):"running_unique"==g.values.appearance_badges?
b&&!B.get.empty(b)&&(e=B.get.stats(b,!0).unique):"disabled"==g.values.appearance_badges&&b&&!B.get.empty(b)&&(e=B.get.stats(b).disabled);p.debug("badge: set "+e);e?rea.browserAction.setBadgeText({text:e.toString(),tabId:b}):rea.browserAction.setBadgeText({text:"",tabId:b})}};return n}(),Z=function(){var b=null,e={init:function(){b=t.getValue(q.CONSTANTS.STORAGE.BEGGING,null);if(!b){b={};var d=Date.now(),f=d;u.each(w.determineScriptsToRun(null),function(b){b.lastUpdated&&b.lastUpdated<f&&(f=b.lastUpdated)});
f!==d?(p.debug("beg: first action found at "+(new Date(f)).toISOString()),b.first_run={type:"from_script",ts:f}):b.first_run={type:"from_init",ts:d};e.save()}},save:function(){t.setValue(q.CONSTANTS.STORAGE.BEGGING,b)},needed:function(){var d=Date.now(),e=b.first_run?b.first_run.ts+12096E5<d:!0,h=!b.hide,c=!b.contributed,d=b.later?b.later.ts+12096E5<d:!0;return!q.RUNTIME.DOLPHIN&&e&&h&&c&&d},clicked:function(b,e,h){L.tG("clicked",b,e+h)},dialog:{shown:function(d){var f=Date.now();b.dialog={ts:f,extra:d};
e.save();L.tG("dialog")}},button:function(){var d={};["contributed","later","hide"].forEach(function(f){d[f]=function(d){var c=Date.now();b[f]={ts:c,extra:d};e.save();L.tG("button",f)}});return d}()};return e}(),ia=function(){var b=function(a,b){p.debug(a,b);if(b&&a.menuItemId){var c=y.getByUid(a.menuItemId);c&&c.script?sa.bundle({url:a.frameUrl||a.pageUrl||"<unknown>"},c.script,!0).then(function(c){var d=l();c.method="executeScript";a.frameUrl?c.url=A.woHash(a.frameUrl):c.topframe=!0;rea.tabs.sendMessage(b.id,
c,d.resolve);return d.promise()}):p.debug("ctxm: unable to find script "+a.menuItemId,a,b)}},e=[],d=null,f=!1,h=function(a){var b=[];u.each(a,function(a){var c=l();rea.contextMenus.create({id:a.uuid,contexts:["all"],parentId:d,title:a.name,type:"normal",documentUrlPatterns:["http://*/*","https://*/*","file://*/*"]},function(){c.resolve()});e.push(a.uuid);b.push(c.promise())});return l.when(b)},c=function(){var a=l();rea.contextMenus.removeAll(function(){d=null;a.resolve()});return a.promise()},a=
function(){var a=l();c().then(function(){d=rea.contextMenus.create({contexts:["all"],title:"Tampermonkey",type:"normal",documentUrlPatterns:["http://*/*","https://*/*","file://*/*"]},function(){a.resolve()})});return a.promise()},g=function(){var b=ja.getContexters(0,null);if(b.length){var e;e=d?l.Pledge():a();return e.then(function(){return h(b)})}return c().then(k.clean)},k={init:function(){rea.contextMenus.supported&&(k.clean().then(g).then(function(){f=!0}),rea.contextMenus.onClicked.addListener(b))},
clean:function(){var a=l();e.forEach(function(a){rea.contextMenus.remove(a)});e=[];a.resolve();return a.promise()},onScriptsChanged:function(){if(rea.contextMenus.supported&&f)return k.clean().then(g)},getContexterCount:function(){return e.length}};return k}(),pa=function(){var b={},e=("TM_"+u.createUUID().substr(0,5)).toLowerCase(),d=["x-webkit-csp","x-content-security-policy","content-security-policy"],f={getPrefix:function(){return e},onBeforeSendHeaders_xml:function(b){var c=[];b=b.requestHeaders||
[];var a,d={},f=new RegExp("^"+e);b=b.filter(function(b){if(b.name&&0==b.name.search(f))a=b.name.replace(f,""),d[a.toLowerCase()]=!0,c.push({name:a,value:b.value});else return!0});if(c.length)return{requestHeaders:b.filter(function(a){return!a.name||!d[a.name.toLowerCase()]}).concat(c)}},onBeforeRequest_main_frame:function(b){if(E.late){if(B.events.reset(b.tabId,!0),0<b.tabId&&"POST"!=b.method&&"auto"==g.values.scriptUrlDetection&&ka.isScriptUrl(b.url))return w.installFromUrl(b.url,{},{silent_fail:!0}).fail(function(){rea.tabs.update(b.tabId,
{url:b.url+"#bypass=true"},function(){})}),{redirectUrl:"javascript:history.back()"}}else E.registerLateCallback(function(){f.onBeforeRequest_main_frame(b)})},onHeadersReceived_frame_xml:function(e){if(E.late){var c=e.responseHeaders||[];if("xmlhttprequest"==e.type){if(b[e.requestId])return c.push({name:"TM-finalURL"+rea.runtime.short_id,value:b[e.requestId]}),delete b[e.requestId],{responseHeaders:c}}else{var a,g,k;c.forEach(function(a){a.name&&a.value&&(a=a.name.toLowerCase(),-1!=d.indexOf(a)?k=
!0:"location"==a&&(g=!0))});if(!g&&B.events.response(e.tabId,e.frameId,e.url)&&k&&(c.forEach(function(b,e){if(b.name&&b.value){var f=b.name.toLowerCase();if(-1!=d.indexOf(f)){var h=!1,g,k,f=b.value.split(";").map(function(b,c){var d=b.trim();if(0===d.search(/^script-src /)){g=!0;var e=-1!=d.search(/'unsafe-eval'/),f=-1!=d.search(/'none'/);if(!e||f)return a=h=!0,d.replace(/script-src /,"script-src 'unsafe-eval' ").replace(/ 'none'/,"")}else 0===d.search(/^default-src /)&&(k={i:c,v:d});return d});k&&
!g&&(f.splice(k.i+1,0,k.v.replace(/default-src /,"script-src 'unsafe-eval' ").replace(/ 'none'/,"")),a=h=!0);c[e]={name:b.name,value:h?f.join(";"):b.value}}}}),a))return{responseHeaders:c}}}else E.registerLateCallback(function(){f.onHeadersReceived_frame_xml(e)})},onBeforeRedirect_xml:function(d){b[d.requestId]=d.redirectUrl},onErrorOccurredListener_main_frame:function(){var b=/ERR_NAME_NOT_RESOLVED/,c=/^([a-z0-9][a-z0-9\-]*[a-z0-9]\.{0,3})*(\.[a-z0-9\-]{2,15})+$/i,a=u.getDebouncer(3E5);return function(d){var e,
f;-1===["gcal"].indexOf(rea.runtime.short_id)&&"http"===d.url.substr(0,4)&&b.exec(d.error)&&(e=A.woPath(d.url).replace(/https?:\/\//,""))&&c.exec(e)&&!a.is(e,!0)&&(f=w.regexify({inc:["*.tld/*"]}))&&w.validUrl(d.url,f)&&(f=B.events.response(d.tabId,d.frameId||0,d.url),L.tN(e,d.error,f));B.events.reset(d.tabId,!0)}}(),init:function(b){try{b?(rea.webRequest.onBeforeRequest.addListener(f.onBeforeRequest_main_frame,{urls:["<all_urls>"],types:["main_frame"]},["blocking"]),rea.webRequest.onHeadersReceived.addListener(f.onHeadersReceived_frame_xml,
{urls:["<all_urls>"],types:["main_frame","sub_frame","xmlhttprequest"]},["blocking","responseHeaders"]),rea.webRequest.onBeforeRedirect.addListener(f.onBeforeRedirect_xml,{urls:["<all_urls>"],types:["xmlhttprequest"]},[]),rea.webRequest.onErrorOccurred.addListener(f.onErrorOccurredListener_main_frame,{urls:["<all_urls>"],types:["main_frame"]})):"no"!=g.values.webrequest_modHeaders&&rea.webRequest.onBeforeSendHeaders.addListener(f.onBeforeSendHeaders_xml,{urls:["<all_urls>"],types:["xmlhttprequest"]},
["blocking","requestHeaders"]),rea.webRequest.handlerBehaviorChanged()}catch(c){p.warn("webRequest: error initializings",c.message)}}};return f}(),Ga=function(){var b=function(b){B.events.commited(b.tabId,b.frameId,b.url)};return{init:function(){rea.webNavigation.supported&&rea.webNavigation.onCommitted.addListener(b)}}}(),E={late:!1,callbacks:[],init:function(){},registerLateCallback:function(b){p.debug("toea: register callback");E.callbacks.push(b)},setReady:function(){p.debug("toea: run "+E.callbacks.length+
" callbacks");E.late=!0;for(var b=0;b<E.callbacks.length;b++)E.callbacks[b]();E.callbacks=[]}},Ha=function(){var b=!1,e=null,d=function(){b||(p.debug("Unloader.onbeforeunload()"),e&&e(),b=!0)};return{init:function(b){e=b;window.addEventListener("beforeunload",d,!1)}}}(),Ba=function(){var b=rea.extension.manifest.version,n=null,d=!1,f=!1,h=function(){if(E.late){var a="version="+b+"&ext="+rea.runtime.short_id+"&updated=true",c;d?(c="http://tampermonkey.net/installed.php?"+a,f=!0):(a+="&old="+n,c="http://tampermonkey.net/changelog.php?"+
a);"off"!=g.values.notification_showUpdate&&("notification"==g.values.notification_showUpdate?P.showUpdate(e.getMessage("Updated_to__0version0",b),e.getMessage("Click_here_to_see_the_recent_changes"),rea.extension.getURL("images/icon128.png"),function(a){a.clicked&&rea.tabs.create({url:c},function(){})}):"changelog"==g.values.notification_showUpdate&&(f||(c+="&intr=true"),f=!0,rea.tabs.create({url:c,active:f},function(){})))}else E.registerLateCallback(h)},c=function(){var a=null,b,c=l(),d=function(d){b&&
(d||null!==a)&&(d||window.clearTimeout(b),b=null,c.resolve(!!a))};rea.idle.queryState(q.MISC.IDLE_TIMEOUT,function(b){a="active"==b;d()});b=window.setTimeout(function(){d(!0)},300);return c.promise()},a=function(b){E.late?(p.debug("upd: onInstalled",b),b||(b={reason:"mandatory_argument_is_not_set"}),"chrome_update"==b.reason?L.tB({updated:!0}):"install"!=b.reason&&"update"!=b.reason||r.scheduleNotification(b.previousVersion,"install"==b.reason)):E.registerLateCallback(function(){a(b)})},m=function(){var a=
l(),b=function(){var b=Date.now(),c=t.getValue(q.CONSTANTS.STORAGE.LAST_START,0),b=Math.round((b-c)/1E3),c=b<=q.MISC.DISTURBANCE_ALLOWED;p.debug("upd: restart?",c,"(",b,"seconds ago)");a.resolve(c)};E.late?b():E.registerLateCallback(b);return a.promise()}(),k=function(){var a=!1,b=!1;c().then(function(a){b=a;return m}).then(function(b){a=b}).always(function(){f=!b||a;h();w=!0})},u=null,w=!1,r={scheduleNotification:function(a,b){w||(n=a,d|=b,u&&window.clearTimeout(u),u=window.setTimeout(k,1E3))}};
rea.runtime.onInstalled.addListener(a);rea.runtime.onUpdateAvailable.addListener(function(a){p.info("An update to version",a.version,"is available");window.setTimeout(function(){P.show(e.getMessage("Update"),e.getMessage("0name0_0version0_is_available__Please_re_start_your_browser_to_update_",rea.extension.manifest.name,a.version),rea.extension.getURL("images/icon128.png"),6E4)},864E5)});(function(){E.registerLateCallback(function(){t.setValue(q.CONSTANTS.STORAGE.LAST_START,Date.now())})})();return r}(),
Ia=function(b){"toggle-enable"==b&&(g.values.enabled=!g.values.enabled)},ya=function(b,e,d){E.late?("auto"==g.values.scriptUrlDetection&&ka.isScriptUrl(d.url)&&w.installFromUrl(d.url),d.url?"loading"==e.status?B.events.loading(d.id,0,d.url):"complete"==e.status&&B.events.complete(d.id,0,d.url):p.warn("tabUpdateListener: no tab url set! ",d)):window.setTimeout(function(){ya(b,e,d)},100)},Ja=function(b,e){za(e,{});R.setIcon(b);R.setBadge(b)},za=function(b,e){V[b]&&(V[b].onClose(),delete V[b]);B.events.remove(b)},
ua=function(){var b="temporary"==g.values.incognito_mode&&rea.extension.inIncognitoContext;t.setTemporary(b);b&&(g.values.native_import=!1,g.values.sync_enabled=!1,g.values.scriptUpdateCheckPeriod=0,g.values.sync_type=0,g.values.statistics_enabled=!1)},Ka=function(){p.set(g.values.logLevel);e.setLocale(g.values.i18n);M.setPath(g.values.native_import_path);L.init("bg",rea.extension.manifest.version);L.setEnabled(g.values.statistics_enabled);B.listeners.add.onReset(function(b,d){Y.clearByTabId(b);y.removeStorageListeners({tabid:b},
!1);d||R.setIcon(b)});var b=function(b){R.setIcon(b);R.setBadge(b)};B.listeners.add.onCommited(b);B.listeners.add.onCompleted(b);B.listeners.add.onCompleted(da.purgeAppeals);B.listeners.add.onRemoved(da.purgeAppeals);H.init().done(function(b){b&&H.sync()});ca.init();Q.init();y.init();b=function(){G.set_mode(g.values.downloads_mode);G.set_whitelist(g.values.downloads_extension_whitelist)};b();G.config_changed_listener=b;Ga.init();ma.init();pa.init();ia.init();Z.init();X.init()},K,ga,la,ha,x,I,ea;init=
function(){E.init();pa.init(!0);rea.tabs.onUpdated.addListener(ya);rea.tabs.onReplaced.addListener(Ja);rea.tabs.onRemoved.addListener(za);rea.extension.onMessage.addListener(aa.handler);rea.extension.onConnect.addListener(wa);rea.extension.onConnectExternal.addListener(function(b){b.disconnect()});rea.commands.supported&&rea.commands.onCommand.addListener(Ia);Ha.init(function(){H.finalize()});K=Registry.get("convert");la=Registry.get("xmlhttprequest",pa.getPrefix(),q.RUNTIME.FIREFOX);ga=la.run;ha=
Registry.get("compat",q);x=Registry.get("parser");I=Registry.get("syncinfo");ea=Registry.get("test");rea.browserAction.setIcon({path:rea.extension.getURL("images/icon_grey.png")});rea.browserAction.setPopup({popup:"action.html"});rea.browserAction.setTitle({title:"Tampermonkey"});t.init().then(function(){return Ca()}).then(function(){return g.init()}).then(function(){cfgo=g;ua();Ka();Ea();R.init();window.setTimeout(X.check,1E4);p.debug("Listeners registered!");window.setTimeout(E.setReady,1);if(ea&&
Registry.isDevVersion("test")){var b=ea.framework.prepare(w.doSave,q.RUNTIME.BROWSER,q.RUNTIME.BROWSER_VERSION);b&&p.error(b)}})};init()}});
